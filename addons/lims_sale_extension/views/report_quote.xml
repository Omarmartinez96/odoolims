<odoo>
  <template id="report_saleorder_custom">
    <t t-call="lims_sale_extension.external_layout_inherit_lims">
      <!-- Definir company en el contexto para evitar KeyError -->
      <t t-set="company" t-value="docs and docs[0].company_id"/>
      <t t-foreach="docs" t-as="doc">
        <main class="o_report_layout" style="margin-top:0 !important;">
          <div class="page">

            <!-- Encabezado interno de cotización -->
            <div class="row" style="margin-bottom:5px;">
              <div class="col-12 text-center">
                <h4 style="color:#090D61; font-size:20px; margin:0;">COTIZACIÓN DE SERVICIOS</h4>
              </div>
            </div>

            <!-- Número de cotización -->
            <table class="table table-borderless mt-1"
                   style="width:100%; font-size:12px; border-collapse:collapse; border-spacing:0;">
              <tr>
                <td style="padding:2px 4px;">
                  <strong>No. de Cotización:</strong> <span t-esc="doc.name"/>
                </td>
              </tr>
            </table>

            <!-- Datos del cliente -->
            <table class="table table-borderless mt-2"
                  style="width:100%; font-size:12px; border-collapse:collapse; border-spacing:0;">
              <t t-set="meses" t-value="{
                '01':'Ene','02':'Feb','03':'Mar','04':'Abr',
                '05':'May','06':'Jun','07':'Jul','08':'Ago',
                '09':'Sep','10':'Oct','11':'Nov','12':'Dic'
              }"/>
              <tbody>
                <!-- Fila 1: Cliente / Fecha -->
                <tr>
                  <td style="width:50%; padding:2px 4px;">
                    <strong>Cliente:</strong> <span t-esc="doc.partner_id.name"/>
                  </td>
                  <td style="width:50%; padding:2px 4px; text-align:right;">
                    <strong>Fecha:</strong>
                    <t t-set="d2" t-value="doc.date_order.strftime('%d')"/>
                    <t t-set="m2" t-value="doc.date_order.strftime('%m')"/>
                    <t t-set="y2" t-value="doc.date_order.strftime('%Y')"/>
                    <span t-esc="d2 + '/' + meses[m2] + '/' + y2"/>
                  </td>
                </tr>
                <!-- Fila 2: Dirección personalizada / Términos de pago -->
                <tr>
                  <td style="padding:2px 4px; vertical-align:top;">
                    <!-- Calle y número -->
                    <span t-esc="doc.partner_id.street"/><br/>
                    <!-- Colonia o complemento -->
                    <t t-if="doc.partner_id.street2">
                      <span t-esc="doc.partner_id.street2"/><br/>
                    </t>
                    <!-- Código postal, ciudad -->
                    <span t-esc="doc.partner_id.zip"/> <span t-esc="doc.partner_id.city"/><br/>
                    <!-- Estado y país -->
                    <span t--if="doc.partner_id.state_id" t-esc="doc.partner_id.state_id.name"/> 
                    <span t-esc="doc.partner_id.country_id.name"/>
                  </td>
                  <td style="padding:2px 4px; text-align:right;">
                    <strong>Términos de pago:</strong> <span t-esc="doc.payment_term_id.name"/>
                  </td>
                </tr>
                <!-- Fila 3: Vigencia -->
                <tr>
                  <td style="padding:2px 4px;">
                    <t t-if="doc.validity_date">
                      <strong>Vigencia hasta:</strong>
                      <t t-set="d" t-value="doc.validity_date.strftime('%d')"/>
                      <t t-set="m" t-value="doc.validity_date.strftime('%m')"/>
                      <t t-set="y" t-value="doc.validity_date.strftime('%Y')"/>
                      <span t-esc="d + '/' + meses[m] + '/' + y"/>
                    </t>
                  </td>
                </tr>
                <!-- Fila 4: En atención a / Correos -->
                <tr t-if="doc.lims_contact_ids">
                  <td style="padding:2px 4px;">
                    <strong>En atención a:</strong>
                    <span t-esc="', '.join([c.name for c in doc.lims_contact_ids])"/>
                  </td>
                  <td style="padding:2px 4px; text-align:right;">
                    <strong>Correos:</strong>
                    <span t-esc="', '.join([c.email for c in doc.lims_contact_ids if c.email])"/>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Tabla de líneas -->
            <table class="table table-borderless mt-2"
                  style="width:100%; font-size:14px; border-collapse:collapse; border-spacing:0;">
              <thead>
                <tr style="background-color:rgb(221,235,247);">
                  <th style="width:40%; padding:4px 2px; text-align:left;"><strong>Descripción</strong></th>
                  <th style="width:10%; padding:4px 2px; text-align:center;"><strong>Cantidad</strong></th>
                  <th style="width:15%; padding:4px 2px; text-align:right;"><strong>Precio unitario</strong></th>
                  <th style="width:15%; padding:4px 2px; text-align:right;"><strong>Descuento</strong></th>
                  <th style="width:20%; padding:4px 2px; text-align:right;"><strong>Subtotal</strong></th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="doc.order_line" t-as="line">
                  <tr>
                    <td style="padding:4px 2px; vertical-align:top;">
                      <strong><span t-esc="line.product_id.display_name"/></strong>
                      <t t-foreach="line.product_id.description_sale.split('\n')" t-as="ln">
                        <t t-if="ln.strip()">
                          <div style="font-size:14px; margin:0;">
                            <span t-esc="ln.strip()"/>
                          </div>
                        </t>
                      </t>
                    </td>
                    <td style="padding:4px 2px; text-align:center;">
                      <span t-field="line.product_uom_qty"
                            t-field-options="{'widget':'float','precision':0}"/>
                    </td>
                    <td style="padding:4px 2px; text-align:right;">
                      <span t-field="line.price_unit"
                            t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                    <td style="padding:4px 2px; text-align:right;">
                      <span t-esc="('%.2f' % line.discount) + '%'" />
                    </td>
                    <td style="padding:4px 2px; text-align:right;">
                      <span t-field="line.price_subtotal"
                            t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>

            <!-- Totales -->
            <div class="row mt-3">
              <div class="col-6"/>
              <div class="col-6" style="font-size:12px;">
                <table class="table table-borderless"
                      style="width:100%; border-collapse:collapse; border-spacing:0;">
                  <!-- Subtotal -->
                  <tr>
                    <td style="text-align:left; padding:6px; border-top:1px solid #ddd;">
                      <strong>Subtotal:</strong>
                    </td>
                    <td style="text-align:right; padding:6px; border-top:1px solid #ddd;">
                      <span t-field="doc.amount_untaxed"
                            t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                  <!-- Calculamos la tasa de IVA (de la primera línea) -->
                  <t t-set="tax_rate" t-value="(doc.order_line and doc.order_line[0].tax_id.amount) or 0"/>
                  <!-- IVA con porcentaje -->
                  <tr>
                    <td style="text-align:left; padding:6px; border-top:1px solid #ddd;">
                      <strong>IVA <span t-esc="('%.0f' % tax_rate)"/>%:</strong>
                    </td>
                    <td style="text-align:right; padding:6px; border-top:1px solid #ddd;">
                      <span t-field="doc.amount_tax"
                            t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                  <!-- Total -->
                  <tr>
                    <td style="text-align:left; padding:6px; font-size:14px; border-top:2px solid #000;">
                      <strong>Total:</strong>
                    </td>
                    <td style="text-align:right; padding:6px; font-size:14px; border-top:2px solid #000;">
                      <span t-field="doc.amount_total"
                            t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                </table>
                <!-- Total en palabras -->
                <t t-set="amount_words" t-value="doc.currency_id.amount_to_text(doc.amount_total)"/>
                <div style="font-size:10px; margin-top:6px; text-align:left;">
                  <em><span t-esc="amount_words.upper()"/> M.N.</em>
                </div>
              </div>
            </div>


            <!-- Notas y políticas (omitir por brevedad) -->
            <!-- ... -->

            <!-- Emitido por y firma -->
            <div style="margin-top:60px;"/>
            <p style="font-size:12px;">
              <strong>Emitido por:</strong> <span t-esc="doc.user_id.name"/>
            </p>
            <div class="row mt-4">
              <div class="col-12" style="text-align:center; margin-top:50px;">
                <t t-if="doc.signature">
                  <img t-attf-src="data:image/png;base64,{{ doc.signature.decode('utf-8') }}"
                       style="max-height:100px; max-width:300px;"/>
                </t>
                <div style="border-top:1px solid #000; width:40%; margin:10px auto 0;"/>
                <p style="margin-top:5px; font-size:12px;">
                  <strong>Firma de aceptación del cliente.</strong>
                </p>
              </div>
            </div>

          </div>
        </main>
      </t>
    </t>
  </template>
</odoo>
