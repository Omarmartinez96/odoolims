<odoo>
  <template id="report_saleorder_custom">
    <t t-call="lims_sale_extension.external_layout_inherit_lims">
      <!-- Definir company en el contexto para evitar KeyError -->
      <t t-set="company" t-value="docs and docs[0].company_id"/>
      <t t-foreach="docs" t-as="doc">
        <main class="o_report_layout" style="margin-top:0 !important;">
          <div class="page">

            <!-- Encabezado interno de cotización -->
            <div class="row" style="margin-bottom:5px;">
              <div class="col-12 text-center">
                <h4 style="color:#090D61; font-size:20px; margin:0;">COTIZACIÓN DE SERVICIOS</h4>
              </div>
            </div>

            <!-- Número de cotización -->
            <table class="table table-borderless mt-1"
                   style="width:100%; font-size:12px; border-collapse:collapse; border-spacing:0;">
              <tr>
                <td style="padding:2px 4px;">
                  <strong>No. de Cotización:</strong> <t t-esc="doc.name"/>
                </td>
              </tr>
            </table>

            <!-- Datos del cliente sin bordes -->
            <table class="table table-borderless mt-2"
                  style="width:100%; font-size:12px; border-collapse:collapse; border-spacing:0;">
              <t t-set="meses" t-value="{
                '01': 'Ene','02': 'Feb','03': 'Mar','04': 'Abr',
                '05': 'May','06': 'Jun','07': 'Jul','08': 'Ago',
                '09': 'Sep','10': 'Oct','11': 'Nov','12': 'Dic'
              }"/>
              <tbody>
                <!-- Fila 1: Cliente / Fecha -->
                <tr>
                  <td style="width:50%; padding:2px 4px;">
                    <strong>Cliente:</strong> <t t-esc="doc.partner_id.name"/>
                  </td>
                  <td style="width:50%; padding:2px 4px; text-align:right;">
                    <strong>Fecha:</strong>
                    <t t-set="d2" t-value="doc.date_order.strftime('%d')"/>
                    <t t-set="m2" t-value="doc.date_order.strftime('%m')"/>
                    <t t-set="y2" t-value="doc.date_order.strftime('%Y')"/>
                    <t t-esc="d2 + '/' + meses[m2] + '/' + y2"/>
                  </td>
                </tr>
                <!-- Fila 2: Dirección / Términos de pago -->
                <tr>
                  <td style="padding:2px 4px;">
                    <t t-esc="doc.partner_id.contact_address"/>
                  </td>
                  <td style="padding:2px 4px; text-align:right;">
                    <strong>Términos de pago:</strong> <t t-esc="doc.payment_term_id.name"/>
                  </td>
                </tr>
                <!-- Fila 3: Vigencia -->
                <tr>
                  <td style="padding:2px 4px;">
                    <t t-if="doc.validity_date">
                      <strong>Vigencia hasta:</strong>
                      <t t-set="d" t-value="doc.validity_date.strftime('%d')"/>
                      <t t-set="m" t-value="doc.validity_date.strftime('%m')"/>
                      <t t-set="y" t-value="doc.validity_date.strftime('%Y')"/>
                      <t t-esc="d + '/' + meses[m] + '/' + y"/>
                    </t>
                  </td>
                </tr>
                <!-- Fila 4: En atención a / Correos -->
                <tr t-if="doc.lims_contact_ids">
                  <td style="padding:2px 4px;">
                    <strong>En atención a:</strong>
                    <t t-esc="', '.join([c.name for c in doc.lims_contact_ids])"/>
                  </td>
                  <td style="padding:2px 4px; text-align:right;">
                    <strong>Correos:</strong>
                    <t t-esc="', '.join([c.email for c in doc.lims_contact_ids if c.email])"/>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Tabla de líneas con Descuento -->
            <table class="table table-borderless mt-2"
                   style="width:100%; font-size:14px; border-collapse:collapse; border-spacing:0;">
              <thead>
                <tr style="background-color:rgb(221,235,247);">
                  <th style="width:40%; padding:4px 2px; text-align:left;"><strong>Descripción</strong></th>
                  <th style="width:10%; padding:4px 2px; text-align:center;"><strong>Cantidad</strong></th>
                  <th style="width:15%; padding:4px 2px; text-align:right;"><strong>Precio unitario</strong></th>
                  <th style="width:15%; padding:4px 2px; text-align:right;"><strong>Descuento</strong></th>
                  <th style="width:20%; padding:4px 2px; text-align:right;"><strong>Subtotal</strong></th>
                </tr>
              </thead>
              <tbody>
                <t t-foreach="doc.order_line" t-as="line">
                  <tr>
                    <td style="padding:4px 2px;">
                      <strong><t t-esc="line.product_id.display_name"/></strong>
                      <t t-foreach="(line.name[len(line.product_id.display_name):] or '').split('\n')" t-as="ln">
                        <t t-if="ln.strip()">
                          <div style="font-size:14px; margin:0;">
                            <t t-esc="ln.strip()"/>
                          </div>
                        </t>
                      </t>
                    </td>
                    <td style="padding:4px 2px; text-align:center;">
                      <t t-field="line.product_uom_qty" t-field-options="{'widget':'float','precision':0}"/>
                    </td>
                    <td style="padding:4px 2px; text-align:right;">
                      <t t-field="line.price_unit"
                         t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                    <td style="padding:4px 2px; text-align:right;">
                      <t t-esc="'%0.2f%%' % line.discount"/>
                    </td>
                    <td style="padding:4px 2px; text-align:right;">
                      <t t-field="line.price_subtotal"
                         t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                </t>
              </tbody>
            </table>

            <!-- Resumen de totales -->
            <div class="row mt-3">
              <div class="col-6"/>
              <div class="col-6" style="font-size:12px;">
                <table class="table table-borderless"
                       style="width:100%; border-collapse:collapse; border-spacing:0;">
                  <!-- Subtotal -->
                  <tr>
                    <td style="text-align:left; padding:6px; border-top:1px solid #ddd;">
                      <strong>Subtotal:</strong>
                    </td>
                    <td style="text-align:right; padding:6px; border-top:1px solid #ddd;">
                      <t t-field="doc.amount_untaxed"
                         t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                  <!-- Impuestos por línea -->
                  <t t-foreach="doc.tax_line_ids" t-as="tax">
                    <tr>
                      <td style="text-align:left; padding:6px; border-top:1px solid #ddd;">
                        <strong><t t-esc="tax.name"/></strong>
                      </td>
                      <td style="text-align:right; padding:6px; border-top:1px solid #ddd;">
                        <t t-field="tax.amount"
                           t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                      </td>
                    </tr>
                  </t>
                  <!-- Total -->
                  <tr>
                    <td style="text-align:left; padding:6px; font-size:14px; border-top:2px solid #000;">
                      <strong>Total:</strong>
                    </td>
                    <td style="text-align:right; padding:6px; font-size:14px; border-top:2px solid #000;">
                      <t t-field="doc.amount_total"
                         t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </td>
                  </tr>
                </table>
                <!-- Total en palabras -->
                <t t-set="amount_words" t-value="doc.currency_id.amount_to_text(doc.amount_total)"/>
                <div style="font-size:10px; margin-top:6px; text-align:left;">
                  <em><t t-esc="amount_words.upper()"/> M.N.</em>
                </div>
              </div>
            </div>

            <!-- Nota de símbolos -->
            <div class="row mt-2" style="font-size:10px;">
              <div class="col-12" style="text-align:left;">
                <em>* Prueba acreditada, ** Prueba subcontratada</em>
              </div>
            </div>

            <!-- Notas adicionales -->
            <t t-if="doc.note">
              <div class="row mt-3">
                <div class="col-12" style="font-size:12px; text-align:left;">
                  <strong>Notas:</strong>
                  <div t-raw="doc.note"/>
                </div>
              </div>
            </t>

            <!-- Condiciones y políticas -->
            <div class="row mt-4">
              <div class="col-12">
                <h5 style="margin-bottom:6px;">Condiciones y políticas de servicio</h5>
                <!-- ... (tu listado extenso de políticas) ... -->
              </div>
            </div>

            <!-- Emitido por y firma -->
            <div style="margin-top:60px;"/>
            <p style="font-size:12px;">
              <strong>Emitido por:</strong> <t t-esc="doc.user_id.name"/>
            </p>
            <div class="row mt-4">
              <div class="col-12" style="text-align:center; margin-top:50px;">
                <t t-if="doc.signature">
                  <img t-attf-src="data:image/png;base64,{{ doc.signature.decode('utf-8') }}"
                       style="max-height:100px; max-width:300px;"/>
                </t>
                <div style="border-top:1px solid #000; width:40%; margin:10px auto 0;"/>
                <p style="margin-top:5px; font-size:12px;"><strong>Firma de aceptación del cliente.</strong></p>
              </div>
            </div>

          </div>
        </main>
      </t>
    </t>
  </template>
</odoo>
