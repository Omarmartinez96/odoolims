<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_saleorder_custom">
    <t t-call="web.html_container">
      <meta charset="UTF-8"/>
      <t t-call-assets="web.report_assets_common" t-js="false"/>
      <t t-set="company" t-value="docs and docs[0].company_id"/>

      <!-- ESTILOS OPTIMIZADOS PARA PDF ENTERPRISE -->
      <t>
        <style>
          body,
          .o_report_layout,
          table,
          td,
          th,
          span,
          div,
          p {
            font-family: "DejaVu Sans", sans-serif !important;
          }
          
          /* Sistema de grid híbrido para descripciones largas */
          .description-grid-container {
            display: block;
            width: 100%;
            margin: 10px 0;
          }
          
          .grid-header {
            display: flex;
            background-color: rgb(218,227,243);
            padding: 8px 4px;
            border: 1px solid #ddd;
            font-weight: bold;
            margin-bottom: 0;
          }
          
          .grid-row {
            display: flex;
            border-left: 1px solid #ddd;
            border-right: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            min-height: 30px;
            page-break-inside: avoid;
          }
          
          .grid-cell-desc {
            flex: 0 0 55%;
            padding: 6px 4px;
            border-right: 1px solid #ddd;
            vertical-align: top;
            word-wrap: break-word;
          }
          
          .grid-cell-numeric {
            flex: 0 0 11.25%;
            padding: 6px 4px;
            border-right: 1px solid #ddd;
            text-align: center;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
          }
          
          .grid-cell-numeric.right {
            text-align: right;
            justify-content: flex-end;
          }
          
          .grid-cell-numeric:last-child {
            border-right: none;
          }
          
          /* Optimización de descripciones largas */
          .description-content {
            font-size: 11px;
            line-height: 1.4;
          }
          
          .description-title {
            font-weight: bold;
            margin-bottom: 4px;
            font-size: 12px;
          }
          
          .description-line {
            margin: 2px 0;
            display: block;
          }
          
          /* Control de height máximo para evitar page-breaks problemáticos */
          .description-chunk {
            max-height: 150px;
            overflow: hidden;
          }
          
          .description-continuation {
            font-style: italic;
            color: #666;
            font-size: 10px;
          }
          
          /* Asegurar espaciado correcto */
          .section-separator {
            clear: both;
            height: 15px;
          }
        </style>
      </t>

      <!-- HEADER SOLO CON LOGO -->
      <div class="header" style="padding: 10px 20px;">
        <img t-if="company.logo"
            t-att-src="image_data_uri(company.logo)"
            style="max-height: 120px; width: auto;"/>
      </div>

      <!-- FOOTER FIJO -->
      <div class="footer">
        <table class="table table-borderless" style="width: 100%; font-size: 10px; border-top: 1px solid #ddd; padding-top: 5px;">
          <tr>
            <td style="width: 33%; text-align: left; padding: 3px;">
              Teléfono: (664) 973-8185
            </td>
            <td style="width: 33%; text-align: center; padding: 3px;">
              FOR-021 Rev. 01 | PROC-005
            </td>
            <td style="width: 33%; text-align: right; padding: 3px;">
              contacto@proteuslaboratorio.com
            </td>
          </tr>
          <tr>
            <td colspan="3" style="text-align: center; font-size: 9px; padding: 2px;">
              <t t-if="company.partner_id">
                <t t-esc="company.partner_id.name"/>,
                <t t-if="company.partner_id.street" t-esc="company.partner_id.street"/>
                <t t-if="company.partner_id.street2">, <t t-esc="company.partner_id.street2"/></t>,
                <t t-if="company.partner_id.city" t-esc="company.partner_id.city"/>,
                <t t-if="company.partner_id.zip">C.P. <t t-esc="company.partner_id.zip"/></t>,
                <t t-if="company.partner_id.country_id" t-esc="company.partner_id.country_id.name"/>
              </t>
            </td>
          </tr>
          <tr>
            <td colspan="3" style="text-align: center; font-size: 9px; padding: 2px;">
              Página <span class="page"/> / <span class="topage"/>
            </td>
          </tr>
        </table>
      </div>

      <!-- DOCUMENTO PRINCIPAL -->
      <t t-foreach="docs" t-as="doc">
        <div class="page">
          <div class="main-content">

            <!-- Título principal -->
            <div style="text-align: center; margin: 20px 0 30px 0;">
              <h1 style="font-size: 24px; font-weight: bold; margin: 0; color: #1f4e79;">COTIZACIÓN</h1>
            </div>

            <!-- Número de cotización -->
            <table class="table table-borderless mt-1"
                  style="width:100%; font-size:18px; border-collapse:collapse; border-spacing:0;">
              <tr>
                <td style="padding:2px 4px;">
                  <strong>No. de Cotización:</strong> <span t-esc="doc.name"/>
                </td>
              </tr>
            </table>

            <!-- Datos del cliente -->
            <table class="table table-borderless mt-2"
                  style="width:100%; font-size:14px; border-collapse:collapse; border-spacing:0;">
              <t t-set="meses" t-value="{
                '01':'Ene','02':'Feb','03':'Mar','04':'Abr',
                '05':'May','06':'Jun','07':'Jul','08':'Ago',
                '09':'Sep','10':'Oct','11':'Nov','12':'Dic'
              }"/>
              <tbody>
                <!-- Fila 1: Cliente / Fecha -->
                <tr>
                  <td style="width:50%; padding:2px 4px;">
                    <strong>Cliente:</strong> <span t-esc="doc.partner_id.name"/>
                  </td>
                  <td style="width:50%; padding:2px 4px; text-align:right;">
                    <strong>Fecha:</strong>
                    <t t-set="d2" t-value="doc.date_order.strftime('%d')"/>
                    <t t-set="m2" t-value="doc.date_order.strftime('%m')"/>
                    <t t-set="y2" t-value="doc.date_order.strftime('%Y')"/>
                    <span t-esc="d2 + '/' + meses[m2] + '/' + y2"/>
                  </td>
                </tr>
                <!-- Fila 2: Dirección personalizada -->
                <tr>
                  <td style="padding:2px 4px; vertical-align:top;">
                    <!-- Calle y número -->
                    <span t-esc="doc.partner_id.street"/><br/>
                    <!-- Colonia o complemento -->
                    <t t-if="doc.partner_id.street2">
                      <span t-esc="doc.partner_id.street2"/><br/>
                    </t>
                    <!-- Código postal, ciudad -->
                    <span t-esc="doc.partner_id.zip"/> <span t-esc="doc.partner_id.city"/><br/>
                    <!-- Estado y país -->
                    <t t-if="doc.partner_id.state_id">
                      <span t-esc="doc.partner_id.state_id.name"/> 
                    </t>
                    <span t-esc="doc.partner_id.country_id.name"/>
                  </td>
                  <td style="padding:2px 4px; text-align:right;">
                    <!-- Espacio reservado -->
                  </td>
                </tr>
                <!-- Fila 3: Vigencia -->
                <tr>
                  <td style="padding:2px 4px;">
                    <t t-if="doc.validity_date">
                      <strong>Vigencia hasta:</strong>
                      <t t-set="d" t-value="doc.validity_date.strftime('%d')"/>
                      <t t-set="m" t-value="doc.validity_date.strftime('%m')"/>
                      <t t-set="y" t-value="doc.validity_date.strftime('%Y')"/>
                      <span t-esc="d + '/' + meses[m] + '/' + y"/>
                    </t>
                  </td>
                </tr>
                <!-- Fila 4: En atención a / Correos -->
                <tr t-if="doc.lims_contact_ids">
                  <td style="padding:2px 4px;">
                    <strong>En atención a:</strong>
                    <span t-esc="', '.join([c.name for c in doc.lims_contact_ids])"/>
                  </td>
                  <td style="padding:2px 4px; text-align:right;">
                    <strong>Correos:</strong>
                    <span t-esc="', '.join([c.email for c in doc.lims_contact_ids if c.email])"/>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- SISTEMA DE GRID HÍBRIDO PARA ANÁLISIS -->
            <div class="description-grid-container">
              
              <!-- Header del grid -->
              <div class="grid-header">
                <div class="grid-cell-desc"><strong>Descripción</strong></div>
                <div class="grid-cell-numeric"><strong>Cant.</strong></div>
                <div class="grid-cell-numeric"><strong>Precio unit.</strong></div>
                <div class="grid-cell-numeric"><strong>Desc.</strong></div>
                <div class="grid-cell-numeric"><strong>Subtotal</strong></div>
              </div>

              <!-- Procesar líneas con control inteligente de altura -->
              <t t-foreach="doc.order_line" t-as="line">
                <t t-set="full_desc" t-value="line.product_id.description_sale or line.product_id.name or ''"/>
                <t t-set="desc_lines" t-value="full_desc.split('\n')"/>
                <t t-set="max_lines_per_chunk" t-value="12"/>
                
                <!-- Si la descripción es corta, mostrar en una sola fila -->
                <t t-if="len(desc_lines) &lt;= max_lines_per_chunk">
                  <div class="grid-row">
                    <div class="grid-cell-desc">
                      <div class="description-title">
                        <span t-esc="line.product_id.display_name"/>
                      </div>
                      <div class="description-content">
                        <t t-foreach="desc_lines" t-as="desc_line">
                          <t t-if="desc_line.strip()">
                            <span class="description-line" t-esc="desc_line.strip()"/>
                          </t>
                        </t>
                      </div>
                    </div>
                    <div class="grid-cell-numeric">
                      <span t-field="line.product_uom_qty" t-field-options="{'widget':'float','precision':0}"/>
                    </div>
                    <div class="grid-cell-numeric right">
                      <span t-field="line.price_unit" t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </div>
                    <div class="grid-cell-numeric right">
                      <span t-esc="('%.2f' % line.discount) + '%'"/>
                    </div>
                    <div class="grid-cell-numeric right">
                      <span t-field="line.price_subtotal" t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                    </div>
                  </div>
                </t>
                
                <!-- Si la descripción es larga, dividir en chunks -->
                <t t-if="len(desc_lines) > max_lines_per_chunk">
                  <t t-set="chunks" t-value="[desc_lines[i:i+max_lines_per_chunk] for i in range(0, len(desc_lines), max_lines_per_chunk)]"/>
                  
                  <t t-foreach="chunks" t-as="chunk">
                    <div class="grid-row">
                      <div class="grid-cell-desc">
                        <!-- Solo mostrar título en el primer chunk -->
                        <t t-if="chunk_index == 0">
                          <div class="description-title">
                            <span t-esc="line.product_id.display_name"/>
                          </div>
                        </t>
                        <t t-if="chunk_index > 0">
                          <div class="description-continuation">
                            (continuación...)
                          </div>
                        </t>
                        <div class="description-content description-chunk">
                          <t t-foreach="chunk" t-as="desc_line">
                            <t t-if="desc_line.strip()">
                              <span class="description-line" t-esc="desc_line.strip()"/>
                            </t>
                          </t>
                        </div>
                      </div>
                      
                      <!-- Solo mostrar datos numéricos en el primer chunk -->
                      <t t-if="chunk_index == 0">
                        <div class="grid-cell-numeric">
                          <span t-field="line.product_uom_qty" t-field-options="{'widget':'float','precision':0}"/>
                        </div>
                        <div class="grid-cell-numeric right">
                          <span t-field="line.price_unit" t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                        </div>
                        <div class="grid-cell-numeric right">
                          <span t-esc="('%.2f' % line.discount) + '%'"/>
                        </div>
                        <div class="grid-cell-numeric right">
                          <span t-field="line.price_subtotal" t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                        </div>
                      </t>
                      
                      <!-- Chunks adicionales con celdas vacías -->
                      <t t-if="chunk_index > 0">
                        <div class="grid-cell-numeric">-</div>
                        <div class="grid-cell-numeric">-</div>
                        <div class="grid-cell-numeric">-</div>
                        <div class="grid-cell-numeric">-</div>
                      </t>
                    </div>
                  </t>
                </t>
              </t>
            </div>

            <!-- Separador para sección de totales -->
            <div class="section-separator"></div>

            <!-- Totales optimizados -->
            <div class="totals-section" style="width:100%; margin-top:20px;">
              <table style="width:50%; float:right; font-size:12px; border-collapse:collapse;">
                <!-- Subtotal -->
                <tr>
                  <td style="text-align:left; padding:6px; border-top:1px solid #ddd;">
                    <strong>Subtotal:</strong>
                  </td>
                  <td style="text-align:right; padding:6px; border-top:1px solid #ddd;">
                    <span t-field="doc.amount_untaxed"
                          t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                  </td>
                </tr>
                <!-- IVA -->
                <t t-set="tax_rate" t-value="(doc.order_line and doc.order_line[0].tax_id.amount) or 0"/>
                <tr>
                  <td style="text-align:left; padding:6px; border-top:1px solid #ddd;">
                    <strong>IVA <span t-esc="('%.0f' % tax_rate)"/>%:</strong>
                  </td>
                  <td style="text-align:right; padding:6px; border-top:1px solid #ddd;">
                    <span t-field="doc.amount_tax"
                          t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                  </td>
                </tr>
                <!-- Total -->
                <tr>
                  <td style="text-align:left; padding:6px; font-size:14px; border-top:2px solid #000;">
                    <strong>Total:</strong>
                  </td>
                  <td style="text-align:right; padding:6px; font-size:14px; border-top:2px solid #000;">
                    <span t-field="doc.amount_total"
                          t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                  </td>
                </tr>
              </table>
            </div>

            <!-- Total en letra -->
            <div style="clear:both; margin-top:20px; font-size:12px;">
              <strong>Total en letra:</strong> 
              <span t-esc="doc.currency_id.amount_to_text(doc.amount_total).upper()"/>
            </div>

            <!-- Términos de pago -->
            <div style="margin-top:12px; font-size:12px;">
              <strong>Términos de pago:</strong> <span t-esc="doc.payment_term_id.name"/>
            </div>

            <!-- Notas de símbolos -->
            <div style="margin-top:25px; font-size:10px;">
              <em>* Acreditado, ** Subrogado</em>
            </div>

            <!-- Emitido por y firma -->
            <div style="margin-top:60px;"/>
            <p style="font-size:12px;">
              <strong>Emitido por:</strong> <span t-esc="doc.user_id.name"/>
            </p>
            <div class="row mt-4">
              <div class="col-12" style="text-align:center; padding-top:180px;">
                <t t-if="doc.signature">
                  <img t-attf-src="data:image/png;base64,{{ doc.signature.decode('utf-8') }}"
                      style="max-height:100px; max-width:300px;"/>
                </t>
                <div style="border-top:1px solid #000; width:40%; margin:10px auto 0;"/>
                <p style="margin-top:5px; font-size:12px;">
                  <strong>FIRMA DEL CLIENTE</strong>
                </p>
                <p style="margin-top:5px; font-size:10px;">
                  <strong>Al firmar esta cotización, confirmarla por cualquier medio (verbal, telefónico, 
                          escrito, electrónico) y/o emitir la orden de compra correspondiente, el cliente 
                          acepta expresamente las condiciones y políticas de servicio detalladas en 
                          este documento. Las confirmaciones verbales deberán ser documentadas por escrito.</strong>
                </p>
              </div>

              <!-- Notas y políticas -->
              <div class="page" style="page-break-before:always;">
                <div class="row mt-4">
                  <div class="col-12">
                    <h5 style="margin-bottom:6px;">Condiciones y políticas de servicio</h5>
                    <ul style="
                        font-size: 10px;
                        line-height: 1.5;
                        list-style-type: none;
                        margin: 0;
                        padding: 0;
                      ">
                      <li><strong>1. Datos de pago:</strong> Los pagos deberán realizarse mediante efectivo, cheque o transferencia electrónica, según lo acordado previamente por escrito con el Laboratorio, a través de sus medios oficiales de comunicación o representantes autorizados.</li>
                      <li><strong>2. Subcontratación de análisis:</strong> Si algún servicio o análisis no se encuentra disponible internamente, las muestras podrán remitirse a un Laboratorio externo previa autorización del Cliente.</li>
                      <li><strong>3. Pago de análisis subcontratados:</strong> Se requiere el pago total para iniciar el procesamiento de pruebas subcontratadas, salvo autorización escrita por el Laboratorio.</li>
                      <li><strong>4. Entrega:</strong> La entrega de productos o informes de ensayo está sujeta al pago íntegro del servicio. Las solicitudes de crédito deben atenderse por los mismos canales de contacto con el Laboratorio mediante autorización escrita.</li>
                      <li><strong>5. Plazos de entrega:</strong> Los tiempos de entrega dependen del tipo y complejidad de la muestra. Los plazos estimados se informarán al momento de la cotización o confirmación del servicio.</li>
                      <li><strong>6. Aclaraciones:</strong> El Laboratorio atenderá solicitudes de aclaración sobre los resultados entregados en un plazo máximo de 5 días hábiles posteriores a su emisión. Pasado ese periodo, no se garantizarán modificaciones al informe.</li>
                      <li><strong>7. Confidencialidad:</strong> Con la autorización de esta cotización o la emisión de la orden de compra, el Laboratorio se compromete a preservar la confidencialidad de toda la información del Cliente, tanto recibida como generada durante la prestación del servicio y el Cliente se compromete a no divulgar información técnica del Laboratorio sin autorización escrita.</li>
                      <li><strong>8. Moneda y ajuste de precios:</strong> Todas las tarifas están expresadas en MXN. Cualquier variación cambiaria, impuestos adicionales o nuevos aranceles aplicables después de la emisión de la cotización podrán repercutirse al Cliente con previo aviso.</li>
                      <li><strong>9. Emisión de factura:</strong> La factura electrónica se emitirá al confirmar el servicio, salvo acuerdo escrito con el Laboratorio.</li>
                      <li><strong>10. Crédito y mora:</strong> En el caso de que el Cliente no cumpla con el plazo de pago otorgado bajo crédito, el Laboratorio se reserva el derecho de suspender los servicios y/o cancelar el crédito concedido automáticamente sin previo aviso.</li>
                      <li><strong>11. Cancelaciones y reprogramaciones:</strong> Las solicitudes de cancelación o cambio de fecha deberán notificarse con al menos 48 horas hábiles de antelación. De no cumplirse este plazo, el Cliente incurrirá en una penalización equivalente al 25% del valor del servicio contratado.</li>
                      <li><strong>12. Responsabilidad del Laboratorio:</strong> La responsabilidad del Laboratorio por cualquier reclamación se limitará al monto facturado por el servicio cuestionado.</li>
                      <li><strong>13. Fuerza mayor:</strong> Ninguna de las partes será responsable por incumplimientos derivados de eventos de fuerza mayor, tales como desastres naturales, pandemias y/o fallos de energía. La parte afectada deberá notificar por escrito en un plazo razonable y reprogramar las obligaciones cuando sea posible.</li>
                      <li><strong>14. Cumplimiento normativo y ética:</strong> El Cliente garantiza que las muestras y los análisis solicitados cumplen con todas las normativas sanitarias, de bioseguridad y de transporte vigentes. El Laboratorio se reserva el derecho de rechazar muestras que no cumplan con estos requisitos.</li>
                      <li><strong>15. Horario de servicio y recargos:</strong> Los trabajos y servicios se prestarán dentro del horario operativo previamente acordado entre el Cliente y el Laboratorio. En caso de que las actividades se extiendan por causas imputables al Cliente o ajenas al Laboratorio, este podrá facturar una cuota adicional por el tiempo extra del operador, calculada a la tarifa vigente por hora hombre.</li>
                      <li><strong>16. Uso de equipamiento:</strong> El Laboratorio no presta, arrienda ni cede bajo ninguna modalidad sus equipos, instrumentos ni materiales de uso interno. Cualquier requerimiento de equipamiento específico deberá canalizarse mediante un contrato de servicio independiente o la adquisición directa de consumibles y accesorios autorizados.</li>
                      <li><strong>17. Disposición de muestras no reclamadas:</strong> Dado que la mayoría de los estudios de microbiología son destructivos, el Laboratorio no podrá devolver muestras o restos de muestra salvo que exista un acuerdo escrito previo; de lo contrario, serán desechadas tras su procesamiento.</li>
                      <li><strong>18. Propiedad intelectual y uso de resultados:</strong> Todos los métodos, procedimientos, protocolos, formatos y resultados generados por el Laboratorio son de su propiedad intelectual y estarán disponibles para el Cliente una vez realizado el pago total del servicio. El Cliente podrá usarlos únicamente con fines internos, regulatorios o contractuales vinculados al servicio solicitado. Se prohíbe su reproducción, distribución o divulgación sin autorización escrita del Laboratorio. El uso indebido podrá generar acciones legales y/o notificación al organismo acreditador correspondiente.</li>
                      <li><strong>19. Legislación aplicable y jurisdicción:</strong> Este contrato se regirá por las leyes de México y para la resolución de cualquier controversia las partes se someten a los tribunales competentes de la ciudad de Tijuana, Baja California.</li>
                      <li><strong>20. Modificaciones y actualizaciones:</strong> El Laboratorio se reserva el derecho de modificar estos términos y políticas en cualquier momento, reflejado en la cotización emitida. El uso continuado de los servicios tras dicha notificación implicará la aceptación de las nuevas condiciones.</li>
                      <li><strong>21. Validez de resultados preliminares:</strong> Los resultados entregados en modo preliminar tienen carácter informativo y estarán sujetos a revisión interna hasta su validación definitiva, la cual se comunicará al Cliente en un informe final.</li>
                      <li><strong>22. Custodia de informes:</strong> El Laboratorio conservará los informes emitidos durante un periodo de 4 años. Pasado este plazo, podrá proceder a su archivo o eliminación conforme a sus procedimientos internos.</li>
                      <li><strong>23. Revisión de resultados:</strong> Si el cliente desea un reanálisis o revisión por disconformidad con los resultados, deberá notificarlo dentro del plazo establecido en la cláusula 6 y correrá con los costos derivados, salvo que se demuestre error por parte del Laboratorio.</li>
                      <li><strong>24. Uso de logotipos de acreditación:</strong> El Cliente no está autorizado a utilizar el logotipo de acreditación del Laboratorio, ni a presentar los informes como certificación de producto.</li>
                    </ul>
                  </div>
                </div>    
              </div>
              

            </div>
          </div>
        </div>  

      </t>
    </t>
  </template>
</odoo>