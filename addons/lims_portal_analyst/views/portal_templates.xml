<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ========================================================= -->
    <!-- TEMPLATE BASE BÁSICO PARA PORTAL LIMS - SIMPLIFICADO FASE 1 -->
    <!-- ========================================================= -->
    <!-- Por ahora sin modificar el layout, acceso directo por URL -->
    <!-- En FASE 2 agregaremos navegación al menú -->

    <!-- ========================================================= -->
    <!-- DASHBOARD BÁSICO -->
    <!-- ========================================================= -->
    <template id="portal_dashboard_basic" name="LIMS Portal Dashboard Básico">
        <t t-call="portal.portal_layout">
            <t t-set="title">Laboratorio - Dashboard</t>
            
            <div class="container mt-3">
                <!-- Header simple -->
                <div class="row">
                    <div class="col-12">
                        <h2>
                            <i class="fa fa-flask text-primary"></i> 
                            Dashboard LIMS
                        </h2>
                        <p class="text-muted">
                            Bienvenido, <strong t-esc="user_name"/>
                        </p>
                    </div>
                </div>

                <!-- Estadísticas básicas -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" t-esc="total_assigned"/>
                                <p class="text-muted mb-0">Total Asignados</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" t-esc="pending_count"/>
                                <p class="text-muted mb-0">Pendientes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info" t-esc="in_progress_count"/>
                                <p class="text-muted mb-0">En Proceso</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" t-esc="completed_count"/>
                                <p class="text-muted mb-0">Completados</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Parámetros recientes -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between">
                                <h5>Parámetros Recientes</h5>
                                <a href="/my/lims/pending" class="btn btn-primary btn-sm">
                                    Ver Todos
                                </a>
                            </div>
                            <div class="card-body">
                                <t t-if="recent_parameters">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Parámetro</th>
                                                <th>Estado</th>
                                                <th>Resultado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="recent_parameters" t-as="param">
                                                <tr>
                                                    <td>
                                                        <strong t-esc="param.name"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="param.portal_status"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="param.result_value">
                                                            <span class="text-success" t-esc="param.result_value"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Sin resultado</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <a t-att-href="'/my/lims/parameter/' + str(param.id)" 
                                                           class="btn btn-sm btn-outline-primary">
                                                            Editar
                                                        </a>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </t>
                                <t t-else="">
                                    <p class="text-center text-muted">
                                        No tienes parámetros asignados.
                                    </p>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- LISTA BÁSICA DE PARÁMETROS -->
    <!-- ========================================================= -->
    <template id="portal_parameter_list_basic" name="Lista Básica de Parámetros Portal">
        <t t-call="portal.portal_layout">
            <t t-set="title">Laboratorio - Parámetros</t>
            
            <div class="container mt-3">
                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <h2>
                            <i class="fa fa-list text-primary"></i> 
                            Mis Parámetros
                        </h2>
                        <p class="text-muted">
                            <span t-esc="total_count"/> parámetros encontrados
                        </p>
                    </div>
                </div>

                <!-- Filtros básicos -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="btn-group" role="group">
                            <a href="/my/lims/pending?status=assigned" 
                               t-att-class="'btn ' + ('btn-primary' if current_status == 'assigned' else 'btn-outline-primary')">
                                Asignados
                            </a>
                            <a href="/my/lims/pending?status=in_progress" 
                               t-att-class="'btn ' + ('btn-primary' if current_status == 'in_progress' else 'btn-outline-primary')">
                                En Proceso
                            </a>
                            <a href="/my/lims/pending?status=completed" 
                               t-att-class="'btn ' + ('btn-primary' if current_status == 'completed' else 'btn-outline-primary')">
                                Completados
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Lista -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <t t-if="parameters">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Parámetro</th>
                                                <th>Muestra</th>
                                                <th>Estado</th>
                                                <th>Prioridad</th>
                                                <th>Resultado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="parameters" t-as="param">
                                                <tr>
                                                    <td>
                                                        <strong t-esc="param.name"/>
                                                    </td>
                                                    <td>
                                                        <span t-esc="param.analysis_id.sample_code"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-secondary" t-esc="param.portal_status"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-info" t-esc="param.portal_priority"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="param.result_value">
                                                            <span class="text-success" t-esc="param.result_value"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Pendiente</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <a t-att-href="'/my/lims/parameter/' + str(param.id)" 
                                                           class="btn btn-sm btn-outline-primary">
                                                            Editar
                                                        </a>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </t>
                                <t t-else="">
                                    <div class="text-center py-4">
                                        <p class="text-muted">No se encontraron parámetros.</p>
                                        <a href="/my/lims" class="btn btn-primary">
                                            Volver al Dashboard
                                        </a>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- FORMULARIO BÁSICO DE PARÁMETRO -->
    <!-- ========================================================= -->
    <template id="portal_parameter_form_basic" name="Formulario Básico de Parámetro Portal">
        <t t-call="portal.portal_layout">
            <t t-set="title" t-value="'Laboratorio - ' + parameter.name"/>
            
            <div class="container mt-3">
                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <h2>
                                    <i class="fa fa-flask text-primary"></i>
                                    <span t-esc="parameter.name"/>
                                </h2>
                                <p class="text-muted">
                                    Muestra: <strong t-esc="analysis.sample_code"/>
                                </p>
                            </div>
                            
                            <div>
                                <a href="/my/lims/pending" class="btn btn-outline-secondary">
                                    <i class="fa fa-arrow-left"></i> Volver
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formulario -->
                <form t-att-action="'/my/lims/parameter/' + str(parameter.id) + '/save'" method="post">
                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                    
                    <div class="row">
                        <!-- Panel principal -->
                        <div class="col-md-8">
                            <!-- Información básica -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Información del Parámetro</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Nombre:</strong> <span t-esc="parameter.name"/></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Estado:</strong> <span t-esc="parameter.portal_status"/></p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Captura de resultado -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h5>Resultado</h5>
                                </div>
                                <div class="card-body">
                                    <div class="form-group">
                                        <label for="result_value">Resultado Principal *</label>
                                        <input type="text" 
                                               class="form-control" 
                                               id="result_value" 
                                               name="result_value"
                                               t-att-value="parameter.result_value or ''"
                                               placeholder="Ingresa el resultado..."/>
                                    </div>

                                    <div class="form-group">
                                        <label for="portal_priority">Prioridad</label>
                                        <select class="form-control" id="portal_priority" name="portal_priority">
                                            <option value="low" t-att-selected="parameter.portal_priority == 'low'">Baja</option>
                                            <option value="normal" t-att-selected="parameter.portal_priority == 'normal'">Normal</option>
                                            <option value="high" t-att-selected="parameter.portal_priority == 'high'">Alta</option>
                                            <option value="urgent" t-att-selected="parameter.portal_priority == 'urgent'">Urgente</option>
                                        </select>
                                    </div>

                                    <div class="form-group">
                                        <label for="portal_notes">Notas</label>
                                        <textarea class="form-control" 
                                                  id="portal_notes" 
                                                  name="portal_notes" 
                                                  rows="3"
                                                  placeholder="Observaciones..."
                                                  t-esc="parameter.portal_notes or ''"/>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Panel lateral -->
                        <div class="col-md-4">
                            <!-- Información de muestra -->
                            <div class="card mb-4">
                                <div class="card-header">
                                    <h6>Información de Muestra</h6>
                                </div>
                                <div class="card-body">
                                    <p><strong>Código:</strong> <span t-esc="analysis.sample_code"/></p>
                                    <t t-if="analysis.customer_id">
                                        <p><strong>Cliente:</strong> <span t-esc="analysis.customer_id.name"/></p>
                                    </t>
                                </div>
                            </div>

                            <!-- Acciones -->
                            <div class="card">
                                <div class="card-header">
                                    <h6>Acciones</h6>
                                </div>
                                <div class="card-body">
                                    <button type="submit" name="action" value="save" class="btn btn-primary btn-block">
                                        Guardar
                                    </button>
                                    
                                    <button type="submit" name="action" value="complete" class="btn btn-success btn-block"
                                            onclick="return confirm('¿Marcar como completado?')">
                                        Guardar y Completar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- TEMPLATE DE ERROR BÁSICO -->
    <!-- ========================================================= -->
    <template id="portal_error_basic" name="Error Portal Básico">
        <t t-call="portal.portal_layout">
            <t t-set="title">Error - Laboratorio</t>
            
            <div class="container mt-5">
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center py-4">
                                <i class="fa fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                                <h4>Error</h4>
                                <p t-esc="error_message"/>
                                <a href="/my/lims" class="btn btn-primary">
                                    Volver al Dashboard
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- DASHBOARD MEJORADO CON ESTADÍSTICAS GLOBALES -->
    <!-- ========================================================= -->
    <template id="portal_dashboard_enhanced" name="Dashboard LIMS Mejorado">
        <t t-call="portal.portal_layout">
            <t t-set="title">Laboratorio - Dashboard</t>
            
            <div class="container mt-3">
                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <h2>
                            <i class="fa fa-flask text-primary"></i> 
                            Dashboard LIMS
                        </h2>
                        <p class="text-muted">
                            Bienvenido, <strong t-esc="user_name"/>
                        </p>
                    </div>
                </div>

                <!-- Estadísticas globales del laboratorio -->
                <div class="row mb-4">
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-primary" t-esc="stats['total_parameters']"/>
                                <p class="text-muted mb-0">Total Lab</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-success" t-esc="stats['available_parameters']"/>
                                <p class="text-muted mb-0">Disponibles</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-info" t-esc="stats['my_parameters']"/>
                                <p class="text-muted mb-0">Mis Asignados</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-warning" t-esc="stats['completed_today']"/>
                                <p class="text-muted mb-0">Hoy Completados</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-danger" t-esc="stats['pending_urgent']"/>
                                <p class="text-muted mb-0">Urgentes</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body">
                                <h3 class="text-secondary" t-esc="stats['assigned_parameters']"/>
                                <p class="text-muted mb-0">Asignados Total</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Acciones rápidas -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-header">
                                <h5>Acciones Rápidas</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <a href="/my/lims/available" class="btn btn-success btn-block">
                                            <i class="fa fa-plus"></i> Ver Disponibles
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="/my/lims/pending?status=my_assigned" class="btn btn-primary btn-block">
                                            <i class="fa fa-user"></i> Mis Asignados
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="/my/lims/available?status=available&amp;portal_priority=urgent" class="btn btn-danger btn-block">
                                            <i class="fa fa-exclamation"></i> Urgentes
                                        </a>
                                    </div>
                                    <div class="col-md-3">
                                        <a href="/my/lims/pending" class="btn btn-info btn-block">
                                            <i class="fa fa-list"></i> Ver Todos
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Mis parámetros recientes -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>Mis Parámetros Recientes</h5>
                            </div>
                            <div class="card-body">
                                <t t-if="my_recent_parameters">
                                    <t t-foreach="my_recent_parameters" t-as="param">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <strong t-esc="param.name"/>
                                                <br/>
                                                <small class="text-muted" t-esc="param.analysis_id.sample_code"/>
                                            </div>
                                            <div>
                                                <a t-att-href="'/my/lims/parameter/' + str(param.id)" 
                                                class="btn btn-sm btn-outline-primary">
                                                    Ver
                                                </a>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <p class="text-muted">No tienes parámetros asignados.</p>
                                    <a href="/my/lims/available" class="btn btn-success">
                                        Tomar Parámetros
                                    </a>
                                </t>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Parámetros urgentes disponibles -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5>🚨 Urgentes Disponibles</h5>
                            </div>
                            <div class="card-body">
                                <t t-if="urgent_available">
                                    <t t-foreach="urgent_available" t-as="param">
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <strong t-esc="param.name"/>
                                                <br/>
                                                <small class="text-muted" t-esc="param.analysis_id.sample_code"/>
                                            </div>
                                            <div>
                                                <form t-att-action="'/my/lims/parameter/' + str(param.id) + '/take'" method="post" style="display: inline;">
                                                    <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                    <button type="submit" class="btn btn-sm btn-danger">
                                                        Tomar
                                                    </button>
                                                </form>
                                            </div>
                                        </div>
                                    </t>
                                </t>
                                <t t-else="">
                                    <p class="text-muted">No hay parámetros urgentes disponibles.</p>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- LISTA DE PARÁMETROS DISPONIBLES CON FILTROS -->
    <!-- ========================================================= -->
    <template id="portal_available_parameters" name="Parámetros Disponibles">
        <t t-call="portal.portal_layout">
            <t t-set="title">Laboratorio - Parámetros Disponibles</t>
            
            <div class="container mt-3">
                <!-- Header -->
                <div class="row">
                    <div class="col-12">
                        <h2>
                            <i class="fa fa-search text-primary"></i> 
                            Parámetros del Laboratorio
                        </h2>
                        <p class="text-muted">
                            <span t-esc="total_count"/> parámetros encontrados
                        </p>
                    </div>
                </div>

                <!-- Filtros -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <form method="get" action="/my/lims/available">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <label>Estado:</label>
                                            <select name="status" class="form-control form-control-sm">
                                                <option value="">Todos</option>
                                                <option value="available" t-att-selected="current_filters.get('status_filter') == 'available'">Disponibles</option>
                                                <option value="my_assigned" t-att-selected="current_filters.get('status_filter') == 'my_assigned'">Mis Asignados</option>
                                                <option value="sin_procesar" t-att-selected="current_filters.get('status_filter') == 'sin_procesar'">Sin Procesar</option>
                                                <option value="en_proceso" t-att-selected="current_filters.get('status_filter') == 'en_proceso'">En Proceso</option>
                                                <option value="finalizado" t-att-selected="current_filters.get('status_filter') == 'finalizado'">Finalizado</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <label>Cliente:</label>
                                            <select name="customer" class="form-control form-control-sm">
                                                <option value="">Todos los clientes</option>
                                                <t t-foreach="customers" t-as="customer">
                                                    <option t-att-value="customer.id" 
                                                            t-att-selected="current_filters.get('customer_id') == str(customer.id)"
                                                            t-esc="customer.name"/>
                                                </t>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <label>Categoría:</label>
                                            <select name="category" class="form-control form-control-sm">
                                                <option value="">Todas</option>
                                                <option value="microbiological" t-att-selected="current_filters.get('category') == 'microbiological'">Microbiológico</option>
                                                <option value="chemical" t-att-selected="current_filters.get('category') == 'chemical'">Químico</option>
                                                <option value="physical" t-att-selected="current_filters.get('category') == 'physical'">Físico</option>
                                            </select>
                                        </div>
                                        
                                        <div class="col-md-3">
                                            <label>Búsqueda:</label>
                                            <div class="input-group">
                                                <input type="text" name="search" class="form-control form-control-sm" 
                                                    t-att-value="current_filters.get('search', '')"
                                                    placeholder="Buscar..."/>
                                                <div class="input-group-append">
                                                    <button type="submit" class="btn btn-primary btn-sm">
                                                        <i class="fa fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de parámetros -->
                <div class="row">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body">
                                <t t-if="parameters">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Parámetro</th>
                                                <th>Muestra</th>
                                                <th>Cliente</th>
                                                <th>Categoría</th>
                                                <th>Estado</th>
                                                <th>Asignado a</th>
                                                <th>Resultado</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <t t-foreach="parameters" t-as="param">
                                                <tr>
                                                    <td>
                                                        <strong t-esc="param.name"/>
                                                        <t t-if="param.microorganism">
                                                            <br/><small class="text-muted" t-esc="param.microorganism"/>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <span t-esc="param.analysis_id.sample_code"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="param.analysis_id.customer_id">
                                                            <span t-esc="param.analysis_id.customer_id.name"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Sin cliente</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-info" t-esc="param.category"/>
                                                    </td>
                                                    <td>
                                                        <span class="badge badge-secondary" t-esc="param.analysis_status_checkbox"/>
                                                    </td>
                                                    <td>
                                                        <t t-if="param.analyst_assigned_id">
                                                            <span t-esc="param.analyst_assigned_id.name"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-success">Disponible</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="param.result_value">
                                                            <span class="text-success" t-esc="param.result_value"/>
                                                        </t>
                                                        <t t-else="">
                                                            <span class="text-muted">Pendiente</span>
                                                        </t>
                                                    </td>
                                                    <td>
                                                        <t t-if="not param.analyst_assigned_id">
                                                            <!-- Botón TOMAR -->
                                                            <form t-att-action="'/my/lims/parameter/' + str(param.id) + '/take'" method="post" style="display: inline;">
                                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                                <button type="submit" class="btn btn-sm btn-success">
                                                                    Tomar
                                                                </button>
                                                            </form>
                                                        </t>
                                                        <t t-elif="param.analyst_assigned_id.id == request.env.user.id">
                                                            <!-- Es MÍO - botones EDITAR y LIBERAR -->
                                                            <a t-att-href="'/my/lims/parameter/' + str(param.id)" 
                                                            class="btn btn-sm btn-outline-primary">
                                                                Editar
                                                            </a>
                                                            <form t-att-action="'/my/lims/parameter/' + str(param.id) + '/release'" method="post" style="display: inline;">
                                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                                <button type="submit" class="btn btn-sm btn-outline-warning" 
                                                                        onclick="return confirm('¿Liberar este parámetro?')">
                                                                    Liberar
                                                                </button>
                                                            </form>
                                                        </t>
                                                        <t t-else="">
                                                            <!-- ASIGNADO A OTRO - solo ver -->
                                                            <span class="text-muted">Asignado</span>
                                                        </t>
                                                    </td>
                                                </tr>
                                            </t>
                                        </tbody>
                                    </table>
                                </t>
                                <t t-else="">
                                    <div class="text-center py-4">
                                        <p class="text-muted">No se encontraron parámetros con los filtros seleccionados.</p>
                                        <a href="/my/lims/available" class="btn btn-primary">
                                            Limpiar Filtros
                                        </a>
                                    </div>
                                </t>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- LISTA AVANZADA ESTILO BACKEND -->
    <!-- ========================================================= -->
    <template id="portal_parameters_advanced_list" name="Lista Avanzada de Parámetros">
        <t t-call="portal.portal_layout">
            <t t-set="title">Laboratorio - Parámetros</t>
            
            <!-- CSS específico para simular backend -->
            <style>
                .odoo-like-header {
                    background: #f8f9fa;
                    border-bottom: 1px solid #dee2e6;
                    padding: 12px 20px;
                    margin: -15px -15px 20px -15px;
                }
                .odoo-like-table {
                    background: white;
                    border-radius: 8px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                }
                .odoo-like-table th {
                    background: #f8f9fa;
                    border-bottom: 2px solid #dee2e6;
                    font-weight: 600;
                    color: #495057;
                    padding: 12px 8px;
                }
                .odoo-like-table td {
                    padding: 10px 8px;
                    border-bottom: 1px solid #f1f1f1;
                    vertical-align: middle;
                }
                .odoo-like-table tr:hover {
                    background: #f8f9fa;
                }
                .badge-priority-urgent { background: #dc3545; }
                .badge-priority-high { background: #fd7e14; }
                .badge-priority-normal { background: #6c757d; }
                .badge-priority-low { background: #28a745; }
                .badge-status-sin_procesar { background: #6c757d; }
                .badge-status-en_proceso { background: #17a2b8; }
                .badge-status-finalizado { background: #28a745; }
                .pagination-info {
                    color: #6c757d;
                    font-size: 0.9rem;
                }
            </style>
            
            <div class="container-fluid mt-3">
                
                <!-- Header estilo Odoo -->
                <div class="odoo-like-header">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <h3 class="mb-0">
                                <i class="fa fa-flask text-primary"></i> 
                                Parámetros de Análisis
                            </h3>
                            <small class="text-muted">
                                <span t-esc="total_count"/> registros encontrados
                            </small>
                        </div>
                        <div class="col-md-6 text-right">
                            <a href="/my/lims" class="btn btn-outline-secondary">
                                <i class="fa fa-arrow-left"></i> Dashboard
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Filtros y búsqueda estilo backend -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="card">
                            <div class="card-body py-2">
                                <form method="get" action="/my/lims/available" class="row align-items-end">
                                    
                                    <!-- Búsqueda -->
                                    <div class="col-md-3">
                                        <label class="form-label">🔍 Buscar</label>
                                        <input type="text" name="search" class="form-control form-control-sm" 
                                            t-att-value="search" 
                                            placeholder="Nombre, muestra, cliente..."/>
                                    </div>
                                    
                                    <!-- Filtro principal -->
                                    <div class="col-md-2">
                                        <label class="form-label">📋 Estado</label>
                                        <select name="filterby" class="form-control form-control-sm">
                                            <option value="all" t-att-selected="filterby == 'all'">Todos</option>
                                            <option value="available" t-att-selected="filterby == 'available'">📋 Disponibles</option>
                                            <option value="my_assigned" t-att-selected="filterby == 'my_assigned'">👤 Mis Asignados</option>
                                            <option value="urgent" t-att-selected="filterby == 'urgent'">🚨 Urgentes</option>
                                            <option value="completed" t-att-selected="filterby == 'completed'">✅ Completados</option>
                                            <option value="microbiological" t-att-selected="filterby == 'microbiological'">🦠 Microbiológicos</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Ordenamiento -->
                                    <div class="col-md-2">
                                        <label class="form-label">📊 Ordenar por</label>
                                        <select name="sortby" class="form-control form-control-sm">
                                            <option value="date" t-att-selected="sortby == 'date'">Fecha</option>
                                            <option value="name" t-att-selected="sortby == 'name'">Nombre</option>
                                            <option value="priority" t-att-selected="sortby == 'priority'">Prioridad</option>
                                            <option value="customer" t-att-selected="sortby == 'customer'">Cliente</option>
                                            <option value="status" t-att-selected="sortby == 'status'">Estado</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Botones -->
                                    <div class="col-md-2">
                                        <button type="submit" class="btn btn-primary btn-sm">
                                            <i class="fa fa-search"></i> Filtrar
                                        </button>
                                        <a href="/my/lims/available" class="btn btn-outline-secondary btn-sm">
                                            <i class="fa fa-times"></i>
                                        </a>
                                    </div>
                                    
                                    <!-- Info de paginación -->
                                    <div class="col-md-3 text-right pagination-info">
                                        Página <strong t-esc="page"/> de <strong t-esc="total_pages"/>
                                        <br/>
                                        <small>(<span t-esc="(page-1) * per_page + 1"/> - <span t-esc="min(page * per_page, total_count)"/> de <span t-esc="total_count"/>)</small>
                                    </div>
                                    
                                </form>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla principal estilo Odoo -->
                <div class="row">
                    <div class="col-12">
                        <div class="odoo-like-table">
                            <t t-if="parameters">
                                <table class="table table-sm mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 3%;">
                                                <input type="checkbox" id="select-all" onclick="toggleAllCheckboxes()"/>
                                            </th>
                                            <th style="width: 20%;">Parámetro</th>
                                            <th style="width: 12%;">Muestra</th>
                                            <th style="width: 15%;">Cliente</th>
                                            <th style="width: 8%;">Categoría</th>
                                            <th style="width: 10%;">Estado</th>
                                            <th style="width: 8%;">Prioridad</th>
                                            <th style="width: 12%;">Asignado a</th>
                                            <th style="width: 12%;">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="parameters" t-as="param">
                                            <tr t-att-data-id="param.id">
                                                <td>
                                                    <input type="checkbox" t-att-value="param.id" class="param-checkbox"/>
                                                </td>
                                                <td>
                                                    <div>
                                                        <strong t-esc="param.name"/>
                                                        <t t-if="param.microorganism">
                                                            <br/>
                                                            <small class="text-muted" t-esc="param.microorganism"/>
                                                        </t>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="badge badge-info" t-esc="param.analysis_id.sample_code"/>
                                                </td>
                                                <td>
                                                    <t t-if="param.analysis_id.customer_id">
                                                        <span t-esc="param.analysis_id.customer_id.name"/>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="text-muted">Sin cliente</span>
                                                    </t>
                                                </td>
                                                <td>
                                                    <span class="badge badge-secondary" t-esc="param.category"/>
                                                </td>
                                                <td>
                                                    <span t-att-class="'badge badge-status-' + param.analysis_status_checkbox" 
                                                        t-esc="param.analysis_status_checkbox"/>
                                                </td>
                                                <td>
                                                    <span t-att-class="'badge badge-priority-' + param.portal_priority" 
                                                        t-esc="param.portal_priority"/>
                                                </td>
                                                <td>
                                                    <t t-if="param.analyst_assigned_id">
                                                        <small t-esc="param.analyst_assigned_id.name"/>
                                                    </t>
                                                    <t t-else="">
                                                        <span class="text-success">📋 Disponible</span>
                                                    </t>
                                                </td>
                                                <td>
                                                    <div class="btn-group btn-group-sm">
                                                        
                                                        <!-- Botón VER/EDITAR -->
                                                        <a t-att-href="'/my/lims/parameter/' + str(param.id)" 
                                                        class="btn btn-outline-primary btn-sm"
                                                        title="Ver/Editar">
                                                            <i class="fa fa-edit"></i>
                                                        </a>
                                                        
                                                        <!-- Botón TOMAR -->
                                                        <t t-if="not param.analyst_assigned_id">
                                                            <form t-att-action="'/my/lims/parameter/' + str(param.id) + '/take'" 
                                                                method="post" style="display: inline;">
                                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                                <button type="submit" class="btn btn-success btn-sm" title="Tomar parámetro">
                                                                    <i class="fa fa-hand-paper-o"></i>
                                                                </button>
                                                            </form>
                                                        </t>
                                                        
                                                        <!-- Botón LIBERAR -->
                                                        <t t-elif="param.analyst_assigned_id.id == request.env.user.id">
                                                            <form t-att-action="'/my/lims/parameter/' + str(param.id) + '/release'" 
                                                                method="post" style="display: inline;">
                                                                <input type="hidden" name="csrf_token" t-att-value="request.csrf_token()"/>
                                                                <button type="submit" class="btn btn-warning btn-sm" 
                                                                        title="Liberar parámetro"
                                                                        onclick="return confirm('¿Liberar este parámetro?')">
                                                                    <i class="fa fa-hand-peace-o"></i>
                                                                </button>
                                                            </form>
                                                        </t>
                                                    </div>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                                
                                <!-- Paginación estilo Odoo -->
                                <div class="card-footer d-flex justify-content-between align-items-center">
                                    <div>
                                        <small class="text-muted">
                                            Mostrando <span t-esc="(page-1) * per_page + 1"/> a <span t-esc="min(page * per_page, total_count)"/> 
                                            de <span t-esc="total_count"/> registros
                                        </small>
                                    </div>
                                    
                                    <nav>
                                        <ul class="pagination pagination-sm mb-0">
                                            <li t-att-class="'page-item' + (' disabled' if not has_previous else '')">
                                                <a class="page-link" 
                                                t-att-href="'/my/lims/available?page=' + str(previous_page) + '&amp;sortby=' + sortby + '&amp;search=' + search + '&amp;filterby=' + filterby">
                                                    Anterior
                                                </a>
                                            </li>
                                            
                                            <t t-foreach="range(max(1, page-2), min(total_pages+1, page+3))" t-as="p">
                                                <li t-att-class="'page-item' + (' active' if p == page else '')">
                                                    <a class="page-link" 
                                                    t-att-href="'/my/lims/available?page=' + str(p) + '&amp;sortby=' + sortby + '&amp;search=' + search + '&amp;filterby=' + filterby"
                                                    t-esc="p"/>
                                                </li>
                                            </t>
                                            
                                            <li t-att-class="'page-item' + (' disabled' if not has_next else '')">
                                                <a class="page-link" 
                                                t-att-href="'/my/lims/available?page=' + str(next_page) + '&amp;sortby=' + sortby + '&amp;search=' + search + '&amp;filterby=' + filterby">
                                                    Siguiente
                                                </a>
                                            </li>
                                        </ul>
                                    </nav>
                                </div>
                                
                            </t>
                            <t t-else="">
                                <div class="text-center py-5">
                                    <i class="fa fa-search fa-3x text-muted mb-3"></i>
                                    <h5>No se encontraron parámetros</h5>
                                    <p class="text-muted">Intenta cambiar los filtros de búsqueda</p>
                                    <a href="/my/lims/available" class="btn btn-primary">
                                        <i class="fa fa-refresh"></i> Limpiar Filtros
                                    </a>
                                </div>
                            </t>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- JavaScript para funcionalidad -->
            <script>
                function toggleAllCheckboxes() {
                    const selectAll = document.getElementById('select-all');
                    const checkboxes = document.querySelectorAll('.param-checkbox');
                    checkboxes.forEach(cb => cb.checked = selectAll.checked);
                }
                
                // Auto-submit form cuando cambia el filtro
                document.querySelectorAll('select[name="filterby"], select[name="sortby"]').forEach(select => {
                    select.addEventListener('change', function() {
                        this.form.submit();
                    });
                });
            </script>
        </t>
    </template>

</odoo>