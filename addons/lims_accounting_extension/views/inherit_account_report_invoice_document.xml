<odoo>
  <template id="inherit_account_report_invoice_document"
            inherit_id="account.report_invoice_document"
            priority="20">
    <xpath expr="//t[@t-call='web.external_layout']" position="replace">
      <!-- Llamamos al layout nativo -->
      <t t-call="lims_accounting_extension.external_layout_invoice_lims">
        <t t-slot="content">
          <t t-set="company" t-value="docs and docs[0].company_id"/>

          <style>
            .custom-row:nth-child(even) {
              background-color: rgb(221, 235, 247);
            }
          </style>

          <t t-foreach="docs" t-as="doc">
            <div class="page">
              <div class="row mb-2">
                <div class="col-6">
                  <strong>No. Factura:</strong> <span t-esc="doc.name"/>
                </div>
                <div class="col-6 text-end">
                  <strong>Fecha:</strong> <span t-esc="doc.invoice_date or doc.date"/>
                </div>
              </div>

              <div class="row mb-3">
                <div class="col-12">
                  <strong>Cliente:</strong> <span t-esc="doc.partner_id.name"/><br/>
                  <small t-esc="doc.partner_id.contact_address"/>
                </div>
              </div>

              <table class="table table-borderless table-sm mb-3"
                     style="width:100%; font-size:11px;">
                <thead>
                  <tr>
                    <th>Descripci√≥n</th>
                    <th class="text-center">Cant.</th>
                    <th class="text-end">Precio U.</th>
                    <th class="text-end">Descuento</th>
                    <th class="text-end">Subtotal</th>
                  </tr>
                </thead>
                <tbody>
                  <t t-foreach="doc.invoice_line_ids" t-as="line">
                    <tr class="custom-row">
                      <td><span t-esc="line.name"/></td>
                      <td class="text-center"><span t-field="line.quantity"/></td>
                      <td class="text-end">
                        <span t-field="line.price_unit"
                              t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                      </td>
                      <td class="text-end">
                        <span t-field="line.discount"
                              t-field-options="{'widget':'percentage'}"/>
                      </td>
                      <td class="text-end">
                        <span t-field="line.price_subtotal"
                              t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                      </td>
                    </tr>
                  </t>
                </tbody>
              </table>

              <div class="row">
                <div class="col-6"/>
                <div class="col-6">
                  <table class="table table-borderless" style="width:100%; font-size:12px;">
                    <tr>
                      <td><strong>Subtotal:</strong></td>
                      <td class="text-end">
                        <span t-field="doc.amount_untaxed"
                              t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                      </td>
                    </tr>

                    <tr>
                      <td><strong>Descuento Total:</strong></td>
                      <td class="text-end">
                        <t t-set="total_discount" t-value="sum([(line.price_unit * line.quantity * (line.discount or 0.0) / 100.0) for line in doc.invoice_line_ids])"/>
                        <span t-esc="total_discount"
                              t-options="{'widget':'monetary', 'display_currency':doc.currency_id}"/>
                      </td>
                    </tr>

                    <tr>
                      <td>
                        <strong>
                          IVA
                          <t t-set="tax_rate" t-value="(doc.amount_untaxed and round((doc.amount_tax / doc.amount_untaxed) * 100.0, 0)) or 0"/>
                          (<t t-esc="tax_rate"/>%)
                        </strong>
                      </td>
                      <td class="text-end">
                        <span t-field="doc.amount_tax"
                              t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                      </td>
                    </tr>

                    <tr>
                      <td><strong>Total:</strong></td>
                      <td class="text-end">
                        <span t-field="doc.amount_total"
                              t-field-options="{'widget':'monetary','display_currency':doc.currency_id}"/>
                      </td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </t>
        </t>
      </t>
    </xpath>
  </template>
</odoo>
