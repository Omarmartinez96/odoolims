<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <template id="report_custody_chain_document">
    <t t-call="web.html_container">
      <meta charset="UTF-8"/>
      <t t-call-assets="web.report_assets_common" t-js="false"/>
      <t t-set="company" t-value="env.company"/>

      <!-- ESTILOS LOCALES -->
      <t>
        <style>
          /* ESTILOS OPTIMIZADOS PARA CALIDAD PROFESIONAL */
          body,
          .o_report_layout,
          table,
          td,
          th,
          span,
          div,
          p {
            font-family: Arial, sans-serif !important;
            font-size: 14px !important;
            line-height: 1.3 !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            text-rendering: optimizeLegibility !important;
          }

          /* ESTILOS ESPECÍFICOS DEL REPORTE */
          .sample-section {
            margin-top: 15px;
            border: 1px solid #ddd;
            padding: 10px;
          }
          
          .parameter-row {
            font-size: 12px;
          }

          /* MEJORAR BORDES Y LÍNEAS */
          table, td, th {
            border-collapse: collapse !important;
          }

          /* LOGOS Y GRÁFICOS MÁS NÍTIDOS */
          img {
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            max-height: 120px !important;
          }

          /* FORZAR CALIDAD DE PÁGINA */
          .page {
            font-size: 14px !important;
            color: #000 !important;
          }

          /* COLORES EXACTOS */
          * {
            -webkit-print-color-adjust: exact !important;
            print-color-adjust: exact !important;
          }
        </style>
      </t>

      <!-- HEADER SOLO CON LOGO -->
      <div class="header" style="padding: 10px 20px;">
        <img t-if="company.logo"
            t-att-src="image_data_uri(company.logo)"
            style="max-height: 100px; width: auto;"/>
      </div>

      <!-- FOOTER FIJO -->
      <div class="footer">
        <table class="table table-borderless" style="width: 100%; font-size: 10px; border-top: 1px solid #ddd; padding-top: 5px;">
          <tr>
            <td style="width: 33%; text-align: left; padding: 3px;">
              Teléfono: (664) 973-8185
            </td>
            <td style="width: 33%; text-align: center; padding: 3px;">
              FOR-021 Rev. 01 | PROC-005
            </td>
            <td style="width: 33%; text-align: right; padding: 3px;">
              contacto@proteuslaboratorio.com
            </td>
          </tr>
          <tr>
            <td colspan="3" style="text-align: center; font-size: 9px; padding: 2px;">
              <t t-if="company.partner_id">
                <t t-esc="company.partner_id.name"/>,
                <t t-if="company.partner_id.street" t-esc="company.partner_id.street"/>
                <t t-if="company.partner_id.street2">, <t t-esc="company.partner_id.street2"/></t>,
                <t t-if="company.partner_id.city" t-esc="company.partner_id.city"/>,
                <t t-if="company.partner_id.zip">C.P. <t t-esc="company.partner_id.zip"/></t>,
                <t t-if="company.partner_id.country_id" t-esc="company.partner_id.country_id.name"/>
              </t>
            </td>
          </tr>
          <tr>
            <td colspan="3" style="text-align: center; font-size: 9px; padding: 2px;">
              Página <span class="page"/> / <span class="topage"/>
            </td>
          </tr>
        </table>
      </div>

      <t t-foreach="docs" t-as="doc">
        <div class="page">
          <div class="main-content">

            <!-- Título principal -->
            <div style="text-align: center; margin: 20px 0 30px 0;">
              <h1 style="font-size: 24px; font-weight: bold; margin: 0;">COMPROBANTE DE CADENA DE CUSTODIA</h1>
            </div>

            <!-- Información de la cadena de custodia -->
            <table class="table table-borderless mt-1"
                  style="width:100%; font-size:14px; border-collapse:collapse; border-spacing:0;">
              <t t-set="meses" t-value="{
                '01':'Ene','02':'Feb','03':'Mar','04':'Abr',
                '05':'May','06':'Jun','07':'Jul','08':'Ago',
                '09':'Sep','10':'Oct','11':'Nov','12':'Dic'
              }"/>
              <tbody>
                <!-- Fila 1: Cadena de Custodia / Fecha del reporte -->
                <tr>
                  <td style="width:50%; padding:4px;">
                    <strong>Cadena de Custodia:</strong> <span t-esc="doc.custody_chain_code"/>
                  </td>
                  <td style="width:50%; padding:4px; text-align:right;">
                    <strong>Fecha de cadena de custodia:</strong>
                    <t t-set="chain_date" t-value="doc.date_chainofcustody"/>
                    <t t-set="d_chain" t-value="chain_date.strftime('%d')"/>
                    <t t-set="m_chain" t-value="chain_date.strftime('%m')"/>
                    <t t-set="y_chain" t-value="chain_date.strftime('%Y')"/>
                    <span t-esc="d_chain + '/' + meses[m_chain] + '/' + y_chain"/>
                  </td>
                </tr>
                <!-- Fila 2: Cliente y código  -->
                <tr>
                  <td style="padding:4px;">
                    <strong>Cliente:</strong> <span t-esc="doc.cliente_id.name"/> 
                    <span style="color: #666;">(<span t-esc="doc.client_code or 'Sin código'"/>)</span>
                  </td>
                </tr>
                <!-- Fila 3: Contactos -->
                <tr t-if="doc.contact_ids">
                  <td colspan="2" style="padding:4px;">
                    <strong>Contactos:</strong>
                    <span t-esc="', '.join([c.name for c in doc.contact_ids])"/>
                  </td>
                </tr>
              </tbody>
            </table>

            <!-- Separador superior -->
            <div style="margin-top: 20px; background-color: rgb(218,227,243); height: 12px; padding: 3px 2px; text-align: center; vertical-align: middle; margin-bottom: 20px;"></div>

            <!-- Muestras -->
            <h3 style="font-size: 18px; margin-bottom: 15px;">Muestras Recolectadas</h3>

            <t t-foreach="doc.sample_ids" t-as="sample">
              <div class="sample-section">
                <h4 style="font-size: 16px; margin: 0 0 10px 0; color: #2c5aa0;">
                  Muestra: <span t-esc="sample.sample_identifier"/>
                </h4>

                <!-- Información de la muestra -->
                <table class="table table-borderless" 
                      style="width:100%; font-size:12px; margin-bottom:10px;">
                  <tbody>
                    <!-- Fila 1: Descripción / Tipo de muestra -->
                    <tr>
                      <td style="width:50%; padding:3px;">
                        <strong>Descripción:</strong> <span t-esc="sample.sample_description or 'No especificada'"/>
                      </td>
                      <td style="width:50%; padding:3px;">
                        <strong>Tipo de muestra:</strong> <span t-esc="sample.sample_type_id.name or 'No especificado'"/>
                      </td>
                    </tr>
                    <!-- Fila 2: Cantidad / Tipo de recipiente -->
                    <tr>
                      <td style="padding:3px;">
                        <strong>Cantidad:</strong> <span t-esc="sample.sample_quantity or 'No especificada'"/>
                      </td>
                      <td style="padding:3px;">
                        <strong>Tipo de recipiente:</strong> <span t-esc="sample.container_type_id.name or 'No especificado'"/>
                      </td>
                    </tr>
                    <!-- Fila 3: Fecha y hora de muestreo -->
                    <tr>
                      <td style="padding:3px;">
                        <strong>Muestreo:</strong> 
                        <t t-if="sample.sampling_date">
                          <t t-set="d_samp" t-value="sample.sampling_date.strftime('%d')"/>
                          <t t-set="m_samp" t-value="sample.sampling_date.strftime('%m')"/>
                          <t t-set="y_samp" t-value="sample.sampling_date.strftime('%Y')"/>
                          <span t-esc="d_samp + '/' + meses[m_samp] + '/' + y_samp"/>
                          <t t-if="sample.sampling_time"> a las <span t-esc="sample.sampling_time"/></t>
                        </t>
                        <span t-else="">No especificado</span>
                      </td>
                      <td style="padding:3px;">
                        <strong>Temperatura de muestreo:</strong> <span t-esc="sample.sampling_temperature or 'No especificada'"/>
                      </td>
                    </tr>
                    <!-- Fila 4: Fecha y hora de recolección -->
                    <tr>
                      <td style="padding:3px;">
                        <strong>Recolección:</strong> 
                        <t t-if="sample.collection_date">
                          <t t-set="d_coll" t-value="sample.collection_date.strftime('%d')"/>
                          <t t-set="m_coll" t-value="sample.collection_date.strftime('%m')"/>
                          <t t-set="y_coll" t-value="sample.collection_date.strftime('%Y')"/>
                          <span t-esc="d_coll + '/' + meses[m_coll] + '/' + y_coll"/>
                          <t t-if="sample.collection_time"> a las <span t-esc="sample.collection_time"/></t>
                        </t>
                        <span t-else="">No especificado</span>
                      </td>
                      <td style="padding:3px;">
                        <!-- Espacio para balance visual -->
                      </td>
                    </tr>
                    <!-- Fila 5: Observaciones de muestreo -->
                    <tr t-if="sample.sampling_observations and sample.sampling_observations != 'N/A'">
                      <td colspan="2" style="padding:3px;">
                        <strong>Observaciones de muestreo:</strong> <span t-esc="sample.sampling_observations"/>
                      </td>
                    </tr>
                    <!-- Fila 6: Observaciones de recolección -->
                    <tr t-if="sample.collection_observations and sample.collection_observations != 'N/A'">
                      <td colspan="2" style="padding:3px;">
                        <strong>Observaciones de recolección:</strong> <span t-esc="sample.collection_observations"/>
                      </td>
                    </tr>
                  </tbody>
                </table>

                <!-- Parámetros de la muestra -->
                <t t-if="sample.parameter_ids">
                  <h5 style="font-size: 14px; margin: 10px 0 5px 0;">Parámetros solicitados:</h5>
                  <table class="table table-bordered" 
                        style="width:100%; font-size:12px; border-collapse:collapse;">
                    <thead>
                      <tr style="background-color:#DAE3F3; color: black;">
                        <th style="padding:6px; text-align:left; width:50%;">Parámetro</th>
                        <th style="padding:6px; text-align:left; width:50%;">Método</th>
                      </tr>
                    </thead>
                    <tbody>
                      <t t-foreach="sample.parameter_ids" t-as="parameter">
                        <tr class="parameter-row">
                          <td style="padding:6px;">
                            <!-- Mostrar microorganismo/analito si existe, sino el nombre del parámetro -->
                            <t t-if="parameter.microorganism">
                              <span t-esc="parameter.microorganism"/>
                            </t>
                            <t t-else="">
                              <span t-esc="parameter.name or 'Sin nombre'"/>
                            </t>
                          </td>
                          <td style="padding:6px;">
                            <span t-esc="parameter.method or 'No especificado'"/>
                          </td>
                        </tr>
                      </t>
                    </tbody>
                  </table>
                </t>
                <t t-else="">
                  <p style="font-style: italic; color: #666; font-size: 12px;">No se han especificado parámetros para esta muestra.</p>
                </t>
              </div>
            </t>

            <!-- Mensaje si no hay muestras -->
            <t t-if="not doc.sample_ids">
              <div style="text-align: center; padding: 40px; background-color: #f8f9fa; border: 1px solid #dee2e6;">
                <p style="font-size: 16px; color: #6c757d; margin: 0;">No se han registrado muestras en esta cadena de custodia.</p>
              </div>
            </t>

            <!-- 🆕 SECCIÓN DE FIRMA DIGITAL -->
            <t t-if="doc.customer_signature">
              <div class="signature-section" style="margin-top: 20px;">
                <h3 style="font-size: 16px; margin: 0 0 15px 0; color: black; text-align: center;">
                  FIRMA DE CONFORMIDAD DEL CLIENTE
                </h3>
                
                <table style="width: 100%; border-collapse: collapse;">
                  <tr>
                    <td style="width: 50%; vertical-align: top; padding: 10px;">
                      <div style="text-align: center; background: none;">
                        <div style="display: inline-block; background: transparent; border: none; padding: 0; margin: 0;">
                          <img t-att-src="image_data_uri(doc.customer_signature)" 
                              style="max-width: 200px; max-height: 100px; border: none; background: transparent; box-shadow: none; outline: none; display: block;"/>
                        </div>
                        <div style="margin-top: 10px; border-top: 1px solid #333; padding-top: 5px;">
                          <strong>Firma del Cliente</strong>
                        </div>
                      </div>
                    </td>
                    <td style="width: 50%; vertical-align: top; padding: 10px;">
                      <div style="font-size: 12px; line-height: 1.5;">
                        <p><strong>Nombre:</strong> <span t-esc="doc.signature_name or 'No especificado'"/></p>
                        <p><strong>Cargo:</strong> <span t-esc="doc.signature_position or 'No especificado'"/></p>
                        <p><strong>Fecha de Firma:</strong> 
                          <t t-if="doc.signature_date">
                            <t t-set="sig_date" t-value="doc.signature_date"/>
                            <t t-set="d_sig" t-value="sig_date.strftime('%d')"/>
                            <t t-set="m_sig" t-value="sig_date.strftime('%m')"/>
                            <t t-set="y_sig" t-value="sig_date.strftime('%Y')"/>
                            <t t-set="h_sig" t-value="sig_date.strftime('%H:%M')"/>
                            <span t-esc="d_sig + '/' + meses[m_sig] + '/' + y_sig + ' ' + h_sig"/>
                          </t>
                          <span t-else="">No especificada</span>
                        </p>
                        <div style="margin-top: 15px; font-style: italic; font-size: 11px; color: #666;">
                          Con mi firma, confirmo haber recibido el comprobante de cadena de custodia y estar conforme con la información contenida en el mismo.
                        </div>
                      </div>
                    </td>
                  </tr>
                </table>
              </div>
            </t>

            <!-- Separador inferior -->
            <div style="margin-top: 20px; background-color: rgb(218,227,243); height: 12px; padding: 3px 2px; text-align: center; vertical-align: middle; margin-bottom: 15px;"></div>

            <!-- Total de muestras al final -->
            <div style="text-align: center; margin-top: 15px; font-size: 16px; font-weight: bold;">
                Total de muestras recolectadas: <span t-esc="len(doc.sample_ids)"/>
            </div>

            <!-- Información adicional -->
            <div style="margin-top: 30px; font-size: 12px; color: #666;">
              <p style="margin-top: 15px;">
                <em>Este comprobante certifica la recolección de las muestras indicadas en la fecha especificada. 
                Los análisis se realizarán conforme a los métodos indicados y las condiciones acordadas.</em>
              </p>
            </div>

          </div>
        </div>
      </t>
    </t>
  </template>
</odoo>