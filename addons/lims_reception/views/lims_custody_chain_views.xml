<?xml version="1.0" encoding="UTF-8"?>
<odoo>
  <data>

    <!-- Formulario de Cadena de Custodia ACTUALIZADO PARA ODOO 17 -->
    <record id="view_lims_custody_chain_form" model="ir.ui.view">
      <field name="name">lims.custody_chain.form</field>
      <field name="model">lims.custody_chain</field>
      <field name="arch" type="xml">
        <form string="Cadena de Custodia">
          <sheet>
            <group string="Datos de la Cadena de Custodia">
              <field name="custody_chain_code" placeholder="Se genera automaticamente"/>
              <field name="date_chainofcustody" placeholder="Fecha de la cadena de custodia"/>
              <field name="time_chainofcustody" placeholder="Hora de la cadena de custodia (HH:MM)"/>
              <field name="cliente_id" placeholder="Selecciona el cliente"/>  
              <field name="client_code" readonly="1"/>
              <field name="sucursal_id" placeholder="Selecciona la sucursal"/> 
              <field name="departamento_id" placerholder="Selecciona el departamento"/>
              <field name="contact_ids"
                     widget="many2many_tags"
                     domain="[('department_id','=',departamento_id)]"
                     invisible="departamento_id == False"
                     placerholder="Selecciona los contactos relacionados a este servicio"/>
              <field name="quotation_id" placeholder="Selecciona la cotizacion relacionada a este servicio"/>
              <field name="chain_of_custody_state" widget="radio"/> 
            </group>

            <!-- GRUPO SEPARADO PARA EL ANALISTA (FUERA DEL GRUPO ANTERIOR) -->
            <group string="Elaborado por" invisible="chain_of_custody_state != 'done'">
                
                <!-- Campo de solo lectura que muestra el analista asignado -->
                <field name="analyst_id" readonly="1" invisible="not analyst_id"/>
                
                <!-- Botón para asignar analista (cuando no hay ninguno) -->
                <button name="action_assign_analyst"
                        type="object"
                        string="Seleccionar responsable"
                        class="btn-primary"
                        invisible="analyst_id"
                        help="Seleccionar y verificar analista que finaliza la cadena"/>
                
                <!-- Botón para cambiar analista (cuando ya hay uno asignado) -->
                <button name="action_change_analyst"
                        type="object"
                        string="🔄 Cambiar responsable"
                        class="btn-secondary"
                        invisible="not analyst_id"
                        help="Cambiar el analista responsable"/>
                        
                <!-- Mensaje informativo -->
                <div invisible="analyst_id" style="color: #6c757d; font-style: italic; margin-top: 10px;">
                    Para finalizar la cadena de custodia, debe asignar un responsable con verificación PIN.
                </div>
                
            </group>

            <!-- 🆕 NUEVA SECCIÓN DE FIRMA -->
            <group string="📋 Estado del Documento" invisible="chain_of_custody_state != 'done'">
              <field name="is_signed" readonly="1"/>
              <field name="signature_name" readonly="1" invisible="is_signed == False"/>
              <field name="signature_date" readonly="1" invisible="is_signed == False"/>
            </group>

            <group string="Observaciones">
              <field name="internal_notes"/>
            </group>

            <notebook>
                <page string="Muestras">
                    <field name="sample_ids" context="{'default_custody_chain_id': id}" mode="list,form">
                        <list>
                            <field name="sample_identifier"/>
                            <field name="sample_description"/>
                            <field name="sample_type_id"/>
                            <field name="sample_state"/>
                            <button name="action_duplicate_sample"
                                    type="object"
                                    string="📋 Duplicar"
                                    class="btn-secondary"
                                    help="Duplicar muestra con todos sus parámetros"/>
                        </list>
                        <form>
                            <sheet>
                                <!-- PLANTILLAS SIN ATTRS -->
                                <group string="Plantilla de Muestra">
                                    <field name="sample_template_id" 
                                          placeholder="Usar plantilla"/>
                                </group>
                                <group string="Datos Generales de la Muestra">
                                    <field name="sample_identifier" placeholder="Inserte identificación de la muestra"/>
                                    <field name="sample_description" placeholder="Inserte descripción de la muestra si aplica"/>
                                    <field name="sample_type_id" placeholder="Seleccione el tipo de muestra"/>
                                    <field name="sample_quantity" placeholder="Inserte la cantidad de muestra"/>
                                    <field name="container_type_id" placeholder="Seleccione el tipo de recipiente"/>
                                </group>
                                <group string="Datos de recolección">
                                  <field name="collection_date" placeholder="Seleccione fecha de recolección"/>
                                  <field name="collection_time" placeholder="Hora de recolección (HH:MM)"/>
                                  <field name="collection_temperature" placeholder="Temperatura de recolección en °C (vacío = N/A en reportes)"/>
                                  <field name="collected_by" placeholder="Inserte nombre del personal de recolección"/>
                                  <field name="collection_observations" placeholder="Inserte observaciones generales de recolección (si aplica)"/>
                                </group>
                                <group string="Datos de Muestreo">
                                  <field name="sampling_plan" nolabel="1" placeholder="Describe el plan de muestreo si aplica" colspan="4"/>
                                  <field name="sampling_date" placeholder="Seleccione fecha de muestreo"/>
                                  <field name="sampling_time" placeholder="Hora de muestreo (HH:MM)"/>
                                  <field name="sampling_temperature" placeholder="Temperatura de recolección en °C (vacío = N/A en reportes)"/>
                                  <field name="sampling_technician" placeholder="Inserte técnico de muestreo"/>
                                  <field name="sampling_observations" placeholder="Inserta observaciones generales de muestreo (si aplica)"/>
                                </group>
                                <group string="Resultados de Campo">
                                    <field name="field_result_ids" 
                                          context="{'default_sample_id': id}" 
                                          nolabel="1">
                                        <list string="Resultados">
                                            <field name="sequence" widget="handle"/>
                                            <field name="parameter_name"/>
                                            <field name="result_value"/>
                                            <field name="unit"/>
                                            <field name="notes"/>
                                        </list>
                                        
                                        <form string="Resultado de Campo">
                                            <group>
                                                <field name="parameter_name"/>
                                                <field name="result_value"/>
                                                <field name="unit"/>
                                            </group>
                                            <group>
                                                <field name="notes"/>
                                            </group>
                                        </form>
                                    </field>
                                </group>

                                <group string="Otros Datos">
                                    <field name="instrument_used"/>
                                    <field name="attachment_ids" widget="many2many_binary"/>
                                </group>

                                <notebook>
                                    <page string="Parámetros de Análisis">
                                        <field name="parameter_ids" context="{'default_sample_id': id}" nolabel="1">
                                            <list string="Parámetros Seleccionados" create="true" edit="false" delete="true">
                                                <field name="name"/>
                                                <field name="microorganism"/>
                                                <field name="category"/>
                                                <field name="method"/>
                                            </list>
                                            
                                            <!-- Formulario SOLO para seleccionar plantilla -->
                                            <form string="Seleccionar Parámetro">
                                                <group>
                                                    <field name="template_id" string="Seleccionar Plantilla" 
                                                          placeholder="Elegir parámetro desde configuración"
                                                          options="{'no_create': True, 'no_open': True}"
                                                          required="1"/>
                                                </group>
                                            </form>
                                        </field>
                                    </page>
                                </notebook>

                            </sheet>
                        </form>
                    </field>
                </page>
            </notebook>

            <!-- 🆕 BOTONES ACTUALIZADOS PARA ODOO 17 -->
            <div style="margin-top: 20px;">
              <div class="oe_button_box" style="display: flex; gap: 10px; justify-content: center;">
                
                <!-- Botón Duplicar Personalizado -->
                <button name="action_duplicate_with_confirmation"
                        type="object"
                        string="📋 Duplicar Cadena"
                        class="btn-secondary"
                        help="Duplicar cadena de custodia con todas sus muestras"/>

                <!-- Botón Vista Previa y Firma -->
                <button name="action_preview_and_sign"
                        type="object"
                        string="✍️ Vista Previa y Firma"
                        class="btn-warning"
                        invisible="chain_of_custody_state != 'done' or is_signed == True"
                        help="Ver el documento y solicitar firma del cliente"/>

                <!-- Botón Ver Documento - MÉTODO DIRECTO -->
                <button name="action_view_signed_document"
                        type="object"
                        string="📄 Ver Documento"
                        class="btn-info"
                        invisible="chain_of_custody_state != 'done'"
                        help="Ver o descargar el documento PDF"/>

                <!-- Botón Enviar Email -->
                <button name="action_send_comprobante_email"
                        type="object"
                        string="📧 Enviar Comprobante"
                        class="btn-primary"
                        invisible="chain_of_custody_state != 'done'"
                        help="Enviar el comprobante por correo electrónico"/>

              </div>
            </div>

          </sheet>
        </form>
      </field>
    </record>

    <!-- Vista de lista de Cadenas de Custodia -->
    <record id="view_lims_custody_chain_list" model="ir.ui.view">
      <field name="name">lims.custody_chain.list</field>
      <field name="model">lims.custody_chain</field>
      <field name="arch" type="xml">
        <list string="Cadenas de Custodia">
          <field name="custody_chain_code"/>
          <field name="cliente_id"/>
          <field name="date_chainofcustody" placeholder="Fecha de la cadena de custodia"/>
          <field name="sucursal_id"/>
          <field name="departamento_id"/>
          <field name="chain_of_custody_state"/>
          <field name="is_signed"/>
        </list>
      </field>
    </record>

    <!-- Acción principal -->
    <record id="action_lims_custody_chains" model="ir.actions.act_window">
      <field name="name">Cadenas de Custodia</field>
      <field name="res_model">lims.custody_chain</field>
      <field name="view_mode">list,form</field>
      <field name="view_id" ref="view_lims_custody_chain_list"/>
    </record>

    <!-- Menús -->
    <menuitem id="lims_custody_menu_root" 
              name="Cadenas de Custodia" sequence="2"/>
    <menuitem id="lims_custody_menu" name="Cadenas de Custodia"
              parent="lims_custody_menu_root"
              action="action_lims_custody_chains" sequence="2"/>

  </data>
</odoo>