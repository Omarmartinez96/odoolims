<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ========== TEMPLATE BASE COMPARTIDO ========== -->
    <template id="report_analysis_base_template">
        <t t-call="web.html_container">
            <meta charset="UTF-8"/>
            <t t-call-assets="web.report_assets_common" t-js="false"/>
            <t t-set="company" t-value="env.company"/>

            <!-- ESTILOS LOCALES -->
            <style>
                body, .o_report_layout, table, td, th, span, div, p {
                    font-family: "DejaVu Sans", sans-serif !important;
                }
                .sample-section {
                    margin-top: 20px;
                    border: 2px solid #2c5aa0;
                    padding: 15px;
                    background-color: #f8f9fa;
                    page-break-inside: avoid;
                }
                .parameter-row {
                    background-color: #e8f4fd;
                    font-size: 11px;
                }
                .result-row {
                    font-size: 12px;
                }
                .header-title {
                    background-color: #2c5aa0;
                    color: white;
                    padding: 8px;
                    text-align: center;
                    font-weight: bold;
                }
                .authorization-section {
                    margin-top: 30px;
                    border: 2px solid #28a745;
                    padding: 15px;
                    background-color: #f8fff8;
                }
                .revision-badge {
                    background-color: #17a2b8;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-weight: bold;
                }
                .preliminary-badge {
                    background-color: #ffc107;
                    color: #212529;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-weight: bold;
                }
                .final-badge {
                    background-color: #28a745;
                    color: white;
                    padding: 5px 10px;
                    border-radius: 5px;
                    font-weight: bold;
                }
            </style>

            <!-- HEADER SOLO CON LOGO -->
            <div class="header" style="padding: 10px 20px;">
                <img t-if="company.logo"
                    t-att-src="image_data_uri(company.logo)"
                    style="max-height: 120px; width: auto;"/>
            </div>

            <!-- FOOTER FIJO -->
            <div class="footer">
                <table class="table table-borderless" style="width: 100%; font-size: 10px; border-top: 1px solid #ddd; padding-top: 5px;">
                    <tr>
                        <td style="width: 33%; text-align: left; padding: 3px;">
                            Teléfono: (664) 973-8185
                        </td>
                        <td style="width: 33%; text-align: center; padding: 3px;">
                            FOR-021 Rev. 01 | PROC-005
                        </td>
                        <td style="width: 33%; text-align: right; padding: 3px;">
                            contacto@proteuslaboratorio.com
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: center; font-size: 9px; padding: 2px;">
                            <t t-if="company.partner_id">
                                <t t-esc="company.partner_id.name"/>,
                                <t t-if="company.partner_id.street" t-esc="company.partner_id.street"/>
                                <t t-if="company.partner_id.street2">, <t t-esc="company.partner_id.street2"/></t>,
                                <t t-if="company.partner_id.city" t-esc="company.partner_id.city"/>,
                                <t t-if="company.partner_id.zip">C.P. <t t-esc="company.partner_id.zip"/></t>,
                                <t t-if="company.partner_id.country_id" t-esc="company.partner_id.country_id.name"/>
                            </t>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: center; font-size: 9px; padding: 2px;">
                            Página <span class="page"/> / <span class="topage"/>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- CONTENIDO DINÁMICO -->
            <t t-raw="0"/>
        </t>
    </template>

    <!-- ========== TEMPLATE PRELIMINAR ========== -->
    <template id="report_analysis_preliminary_template">
        <t t-call="lims_analysis_v2.report_analysis_base_template">
            <t t-foreach="docs" t-as="analysis">
                <div class="page">
                    <div class="main-content">

                        <!-- Título principal -->
                        <div style="text-align: center; margin: 20px 0 30px 0;">
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">
                                REPORTE PRELIMINAR DE RESULTADOS
                                <t t-if="analysis.is_revision and analysis.revision_number > 0">
                                    <br/><span class="revision-badge">REVISIÓN N° <t t-esc="analysis.revision_number"/></span>
                                </t>
                            </h1>
                        </div>

                        <!-- Información del reporte -->
                        <table class="table table-borderless mt-1" style="width:100%; font-size:14px; border-collapse:collapse;">
                            <t t-set="meses" t-value="{
                                '01':'Ene','02':'Feb','03':'Mar','04':'Abr',
                                '05':'May','06':'Jun','07':'Jul','08':'Ago',
                                '09':'Sep','10':'Oct','11':'Nov','12':'Dic'
                            }"/>
                            <tbody>
                                <tr>
                                    <td style="width:50%; padding:4px;">
                                        <strong>Cadena de Custodia:</strong> 
                                        <span t-esc="analysis.custody_chain_code"/>
                                    </td>
                                    <td style="width:50%; padding:4px; text-align:right;">
                                        <strong>Fecha de emisión:</strong>
                                        <t t-set="today" t-value="datetime.datetime.now()"/>
                                        <t t-set="d_today" t-value="today.strftime('%d')"/>
                                        <t t-set="m_today" t-value="today.strftime('%m')"/>
                                        <t t-set="y_today" t-value="today.strftime('%Y')"/>
                                        <span t-esc="d_today + '/' + meses[m_today] + '/' + y_today"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">
                                        <strong>Cliente:</strong> <span t-esc="analysis.customer_id.name"/>
                                    </td>
                                    <td style="padding:4px; text-align:right;">
                                        <span class="preliminary-badge">PRELIMINAR</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">
                                        <strong>Muestra:</strong> <span t-esc="analysis.sample_code"/> - <span t-esc="analysis.sample_identifier"/>
                                    </td>
                                    <td style="padding:4px; text-align:right;">
                                        <strong>Fecha de Recepción:</strong>
                                        <t t-if="analysis.reception_date">
                                            <t t-set="r_date" t-value="analysis.reception_date"/>
                                            <t t-set="d_reception" t-value="r_date.strftime('%d')"/>
                                            <t t-set="m_reception" t-value="r_date.strftime('%m')"/>
                                            <t t-set="y_reception" t-value="r_date.strftime('%Y')"/>
                                            <span t-esc="d_reception + '/' + meses[m_reception] + '/' + y_reception"/>
                                        </t>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Separador -->
                        <hr style="margin: 20px 0; border: 1px solid;"/>

                        <!-- Nota preliminar -->
                        <div style="text-align: center; margin: 20px 0; padding: 15px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                            <strong>📋 NOTA:</strong> Este es un reporte preliminar que contiene resultados parciales disponibles. 
                            Los resultados pueden estar sujetos a cambios en el reporte final.
                        </div>

                        <!-- Resultados de la muestra -->
                        <div class="sample-section">
                            
                            <!-- Header de la muestra -->
                            <div class="header-title">
                                Muestra: <span t-esc="analysis.sample_code"/> - <span t-esc="analysis.sample_identifier"/>
                            </div>

                            <!-- Información básica -->
                            <table class="table table-borderless" style="width:100%; font-size:12px; margin: 10px 0;">
                                <tbody>
                                    <tr>
                                        <td style="width:50%; padding:3px;">
                                            <strong>Descripción:</strong> 
                                            <span t-esc="analysis.sample_reception_id.sample_id.sample_description or 'No especificada'"/>
                                        </td>
                                        <td style="width:50%; padding:3px;">
                                            <strong>Tipo:</strong> 
                                            <span t-esc="analysis.sample_reception_id.sample_id.sample_type_id.name or 'No especificado'"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:3px;">
                                            <strong>Fecha de Análisis:</strong> 
                                            <t t-if="analysis.analysis_start_date">
                                                <t t-set="a_date" t-value="analysis.analysis_start_date"/>
                                                <t t-set="d_analysis" t-value="a_date.strftime('%d')"/>
                                                <t t-set="m_analysis" t-value="a_date.strftime('%m')"/>
                                                <t t-set="y_analysis" t-value="a_date.strftime('%Y')"/>
                                                <span t-esc="d_analysis + '/' + meses[m_analysis] + '/' + y_analysis"/>
                                            </t>
                                            <span t-else="">No especificada</span>
                                        </td>
                                        <td style="padding:3px;">
                                            <strong>Parámetros Listos:</strong> 
                                            <span t-esc="analysis.ready_parameters_count"/> de <span t-esc="analysis.total_parameters_count"/>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Tabla de resultados LISTOS -->
                            <t t-set="ready_params" t-value="analysis.parameter_analysis_ids.filtered(lambda p: p.report_status == 'ready')"/>
                            
                            <t t-if="ready_params">
                                <h5 style="font-size: 14px; margin: 15px 0 5px 0;">Resultados Preliminares:</h5>
                                <table class="table table-bordered" style="width:100%; font-size:11px; border-collapse:collapse;">
                                    <thead>
                                        <tr style="background-color:#2c5aa0; color: white;">
                                            <th style="padding:8px; text-align:left; width:25%;">Parámetro</th>
                                            <th style="padding:8px; text-align:left; width:25%;">Método</th>
                                            <th style="padding:8px; text-align:center; width:20%;">Resultado</th>
                                            <th style="padding:8px; text-align:left; width:30%;">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="ready_params" t-as="parameter">
                                            <tr class="result-row">
                                                <td style="padding:8px;">
                                                    <t t-if="parameter.microorganism">
                                                        <strong><span t-esc="parameter.microorganism"/></strong>
                                                    </t>
                                                    <t t-else="">
                                                        <strong><span t-esc="parameter.name or 'Sin nombre'"/></strong>
                                                    </t>
                                                </td>
                                                <td style="padding:8px;">
                                                    <span t-esc="parameter.method or 'No especificado'"/>
                                                </td>
                                                <td style="padding:8px; text-align:center; font-weight:bold;">
                                                    <span t-esc="parameter.result_complete or parameter.result_value or 'Sin resultado'"/>
                                                </td>
                                                <td style="padding:8px; font-size:10px;">
                                                    <span t-esc="parameter.analyst_notes or '—'"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>
                            <t t-else="">
                                <div style="text-align: center; padding: 20px; background-color: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px;">
                                    <p style="margin: 0; font-style: italic; color: #856404;">
                                        No hay resultados preliminares disponibles para esta muestra.
                                    </p>
                                </div>
                            </t>

                        </div>

                        <!-- Información adicional -->
                        <div style="margin-top: 30px; font-size: 11px; color: #666;">
                            <p>
                                <strong>Tipo de Reporte:</strong> Este es un reporte preliminar que contiene resultados parciales disponibles a la fecha de emisión.
                                Los resultados están sujetos a verificación y pueden cambiar en el reporte final.
                            </p>
                            <p style="margin-top: 10px;">
                                <em>Los análisis se realizaron conforme a los métodos indicados y bajo las condiciones establecidas en nuestros procedimientos de calidad.</em>
                            </p>
                        </div>

                    </div>
                </div>
            </t>
        </t>
    </template>

    <!-- ========== TEMPLATE FINAL ========== -->
    <template id="report_analysis_final_template">
        <t t-call="lims_analysis_v2.report_analysis_base_template">
            <t t-foreach="docs" t-as="analysis">
                <div class="page">
                    <div class="main-content">

                        <!-- Título principal -->
                        <div style="text-align: center; margin: 20px 0 30px 0;">
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">
                                REPORTE FINAL DE RESULTADOS DE ANÁLISIS
                                <t t-if="analysis.is_revision and analysis.revision_number > 0">
                                    <br/><span class="revision-badge">REVISIÓN N° <t t-esc="analysis.revision_number"/></span>
                                </t>
                            </h1>
                        </div>

                        <!-- Información del reporte -->
                        <table class="table table-borderless mt-1" style="width:100%; font-size:14px; border-collapse:collapse;">
                            <t t-set="meses" t-value="{
                                '01':'Ene','02':'Feb','03':'Mar','04':'Abr',
                                '05':'May','06':'Jun','07':'Jul','08':'Ago',
                                '09':'Sep','10':'Oct','11':'Nov','12':'Dic'
                            }"/>
                            <tbody>
                                <tr>
                                    <td style="width:50%; padding:4px;">
                                        <strong>Cadena de Custodia:</strong> 
                                        <span t-esc="analysis.custody_chain_code"/>
                                    </td>
                                    <td style="width:50%; padding:4px; text-align:right;">
                                        <strong>Fecha de emisión:</strong>
                                        <t t-set="today" t-value="datetime.datetime.now()"/>
                                        <t t-set="d_today" t-value="today.strftime('%d')"/>
                                        <t t-set="m_today" t-value="today.strftime('%m')"/>
                                        <t t-set="y_today" t-value="today.strftime('%Y')"/>
                                        <span t-esc="d_today + '/' + meses[m_today] + '/' + y_today"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">
                                        <strong>Cliente:</strong> <span t-esc="analysis.customer_id.name"/>
                                    </td>
                                    <td style="padding:4px; text-align:right;">
                                        <span class="final-badge">FINAL</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">
                                        <strong>Muestra:</strong> <span t-esc="analysis.sample_code"/> - <span t-esc="analysis.sample_identifier"/>
                                    </td>
                                    <td style="padding:4px; text-align:right;">
                                        <strong>Fecha de Recepción:</strong>
                                        <t t-if="analysis.reception_date">
                                            <t t-set="r_date" t-value="analysis.reception_date"/>
                                            <t t-set="d_reception" t-value="r_date.strftime('%d')"/>
                                            <t t-set="m_reception" t-value="r_date.strftime('%m')"/>
                                            <t t-set="y_reception" t-value="r_date.strftime('%Y')"/>
                                            <span t-esc="d_reception + '/' + meses[m_reception] + '/' + y_reception"/>
                                        </t>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Separador -->
                        <hr style="margin: 20px 0; border: 1px solid;"/>

                        <!-- Resultados de la muestra -->
                        <div class="sample-section">
                            
                            <!-- Header de la muestra -->
                            <div class="header-title">
                                Muestra: <span t-esc="analysis.sample_code"/> - <span t-esc="analysis.sample_identifier"/>
                            </div>

                            <!-- Información básica -->
                            <table class="table table-borderless" style="width:100%; font-size:12px; margin: 10px 0;">
                                <tbody>
                                    <tr>
                                        <td style="width:50%; padding:3px;">
                                            <strong>Descripción:</strong> 
                                            <span t-esc="analysis.sample_reception_id.sample_id.sample_description or 'No especificada'"/>
                                        </td>
                                        <td style="width:50%; padding:3px;">
                                            <strong>Tipo:</strong> 
                                            <span t-esc="analysis.sample_reception_id.sample_id.sample_type_id.name or 'No especificado'"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:3px;">
                                            <strong>Fecha de Análisis:</strong> 
                                            <t t-if="analysis.analysis_start_date">
                                                <t t-set="a_date" t-value="analysis.analysis_start_date"/>
                                                <t t-set="d_analysis" t-value="a_date.strftime('%d')"/>
                                                <t t-set="m_analysis" t-value="a_date.strftime('%m')"/>
                                                <t t-set="y_analysis" t-value="a_date.strftime('%Y')"/>
                                                <span t-esc="d_analysis + '/' + meses[m_analysis] + '/' + y_analysis"/>
                                            </t>
                                            <span t-else="">No especificada</span>
                                        </td>
                                        <td style="padding:3px;">
                                            <strong>Estado:</strong> 
                                            <span style="color: #28a745; font-weight: bold;">✅ Análisis Completo</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Tabla de resultados TODOS -->
                            <t t-set="all_params" t-value="analysis.parameter_analysis_ids.filtered(lambda p: p.report_status in ['ready', 'reported'])"/>
                            
                            <t t-if="all_params">
                                <h5 style="font-size: 14px; margin: 15px 0 5px 0;">Resultados Finales:</h5>
                                <table class="table table-bordered" style="width:100%; font-size:11px; border-collapse:collapse;">
                                    <thead>
                                        <tr style="background-color:#2c5aa0; color: white;">
                                            <th style="padding:8px; text-align:left; width:25%;">Parámetro</th>
                                            <th style="padding:8px; text-align:left; width:25%;">Método</th>
                                            <th style="padding:8px; text-align:center; width:20%;">Resultado</th>
                                            <th style="padding:8px; text-align:left; width:30%;">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="all_params" t-as="parameter">
                                            <tr class="result-row">
                                                <td style="padding:8px;">
                                                    <t t-if="parameter.microorganism">
                                                        <strong><span t-esc="parameter.microorganism"/></strong>
                                                    </t>
                                                    <t t-else="">
                                                        <strong><span t-esc="parameter.name or 'Sin nombre'"/></strong>
                                                    </t>
                                                </td>
                                                <td style="padding:8px;">
                                                    <span t-esc="parameter.method or 'No especificado'"/>
                                                </td>
                                                <td style="padding:8px; text-align:center; font-weight:bold;">
                                                    <span t-esc="parameter.result_complete or parameter.result_value or 'Sin resultado'"/>
                                                </td>
                                                <td style="padding:8px; font-size:10px;">
                                                    <span t-esc="parameter.analyst_notes or '—'"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>

                        </div>

                        <!-- SECCIÓN DE FIRMA DE MUESTRA (SOLO SI ESTÁ FIRMADA) -->
                        <t t-if="analysis.signature_state == 'signed'">
                            <div class="authorization-section" style="border-color: #007bff; background-color: #f8f9ff;">
                                <h3 style="font-size: 16px; margin: 0 0 15px 0; color: #007bff; text-align: center;">
                                    FIRMA DE MUESTRA - <span t-esc="analysis.sample_code"/>
                                </h3>
                                
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr>
                                        <td style="width: 50%; vertical-align: top; padding: 10px; text-align: center;">
                                            <t t-if="analysis.sample_digital_signature">
                                                <img t-att-src="image_data_uri(analysis.sample_digital_signature)" 
                                                    style="max-width: 200px; max-height: 100px; border: 1px solid #007bff; padding: 5px;"/>
                                            </t>
                                            <div style="margin-top: 10px; border-top: 2px solid #007bff; padding-top: 5px;">
                                                <strong>Firma de Muestra</strong>
                                            </div>
                                        </td>
                                        <td style="width: 50%; vertical-align: top; padding: 10px;">
                                            <div style="font-size: 12px; line-height: 1.6;">
                                                <p><strong>Firmado por:</strong> <span t-esc="analysis.sample_signature_name or 'No especificado'"/></p>
                                                <p><strong>Cargo:</strong> <span t-esc="analysis.sample_signature_position or 'No especificado'"/></p>
                                                <p><strong>Fecha de Firma:</strong> 
                                                    <t t-if="analysis.sample_signature_date">
                                                        <t t-set="sign_date" t-value="analysis.sample_signature_date"/>
                                                        <t t-set="d_sign" t-value="sign_date.strftime('%d')"/>
                                                        <t t-set="m_sign" t-value="sign_date.strftime('%m')"/>
                                                        <t t-set="y_sign" t-value="sign_date.strftime('%Y')"/>
                                                        <t t-set="h_sign" t-value="sign_date.strftime('%H:%M')"/>
                                                        <span t-esc="d_sign + '/' + meses[m_sign] + '/' + y_sign + ' ' + h_sign"/>
                                                    </t>
                                                    <span t-else="">No especificada</span>
                                                </p>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </t>

                        <!-- Información adicional -->
                        <div style="margin-top: 30px; font-size: 11px; color: #666;">
                            <p>
                                <strong>Tipo de Reporte:</strong> Este es un reporte final que contiene todos los resultados solicitados para las muestras analizadas.
                            </p>
                            <p style="margin-top: 10px;">
                                <em>Los análisis se realizaron conforme a los métodos indicados y bajo las condiciones establecidas en nuestros procedimientos de calidad.</em>
                            </p>
                        </div>

                    </div>
                </div>
            </t>
        </t>
    </template>

    <!-- ========== TEMPLATE PARA FIRMA MANUAL ========== -->
    <template id="report_analysis_signing_template">
        <t t-call="lims_analysis_v2.report_analysis_base_template">
            <t t-foreach="docs" t-as="analysis">
                <div class="page">
                    <div class="main-content">

                        <!-- Título principal -->
                        <div style="text-align: center; margin: 20px 0 30px 0;">
                            <h1 style="font-size: 24px; font-weight: bold; margin: 0;">
                                INFORME PARA FIRMA AUTÓGRAFA
                                <t t-if="analysis.is_revision and analysis.revision_number > 0">
                                    <br/><span class="revision-badge">REVISIÓN N° <t t-esc="analysis.revision_number"/></span>
                                </t>
                            </h1>
                        </div>

                        <!-- Información del reporte -->
                        <table class="table table-borderless mt-1" style="width:100%; font-size:14px; border-collapse:collapse;">
                            <t t-set="meses" t-value="{
                                '01':'Ene','02':'Feb','03':'Mar','04':'Abr',
                                '05':'May','06':'Jun','07':'Jul','08':'Ago',
                                '09':'Sep','10':'Oct','11':'Nov','12':'Dic'
                            }"/>
                            <tbody>
                                <tr>
                                    <td style="width:50%; padding:4px;">
                                        <strong>Cadena de Custodia:</strong> 
                                        <span t-esc="analysis.custody_chain_code"/>
                                    </td>
                                    <td style="width:50%; padding:4px; text-align:right;">
                                        <strong>Fecha de emisión:</strong>
                                        <t t-set="today" t-value="datetime.datetime.now()"/>
                                        <t t-set="d_today" t-value="today.strftime('%d')"/>
                                        <t t-set="m_today" t-value="today.strftime('%m')"/>
                                        <t t-set="y_today" t-value="today.strftime('%Y')"/>
                                        <span t-esc="d_today + '/' + meses[m_today] + '/' + y_today"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">
                                        <strong>Cliente:</strong> <span t-esc="analysis.customer_id.name"/>
                                    </td>
                                    <td style="padding:4px; text-align:right;">
                                        <span style="background-color: #6c757d; color: white; padding: 5px 10px; border-radius: 5px; font-weight: bold;">PARA FIRMA MANUAL</span>
                                    </td>
                                </tr>
                                <tr>
                                    <td style="padding:4px;">
                                        <strong>Muestra:</strong> <span t-esc="analysis.sample_code"/> - <span t-esc="analysis.sample_identifier"/>
                                    </td>
                                    <td style="padding:4px; text-align:right;">
                                        <strong>Fecha de Recepción:</strong>
                                        <t t-if="analysis.reception_date">
                                            <t t-set="r_date" t-value="analysis.reception_date"/>
                                            <t t-set="d_reception" t-value="r_date.strftime('%d')"/>
                                            <t t-set="m_reception" t-value="r_date.strftime('%m')"/>
                                            <t t-set="y_reception" t-value="r_date.strftime('%Y')"/>
                                            <span t-esc="d_reception + '/' + meses[m_reception] + '/' + y_reception"/>
                                        </t>
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- Separador -->
                        <hr style="margin: 20px 0; border: 1px solid;"/>

                        <!-- Resultados de la muestra -->
                        <div class="sample-section">
                            
                            <!-- Header de la muestra -->
                            <div class="header-title">
                                Muestra: <span t-esc="analysis.sample_code"/> - <span t-esc="analysis.sample_identifier"/>
                            </div>

                            <!-- Información básica -->
                            <table class="table table-borderless" style="width:100%; font-size:12px; margin: 10px 0;">
                                <tbody>
                                    <tr>
                                        <td style="width:50%; padding:3px;">
                                            <strong>Descripción:</strong> 
                                            <span t-esc="analysis.sample_reception_id.sample_id.sample_description or 'No especificada'"/>
                                        </td>
                                        <td style="width:50%; padding:3px;">
                                            <strong>Tipo:</strong> 
                                            <span t-esc="analysis.sample_reception_id.sample_id.sample_type_id.name or 'No especificado'"/>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td style="padding:3px;">
                                            <strong>Fecha de Análisis:</strong> 
                                            <t t-if="analysis.analysis_start_date">
                                                <t t-set="a_date" t-value="analysis.analysis_start_date"/>
                                                <t t-set="d_analysis" t-value="a_date.strftime('%d')"/>
                                                <t t-set="m_analysis" t-value="a_date.strftime('%m')"/>
                                                <t t-set="y_analysis" t-value="a_date.strftime('%Y')"/>
                                                <span t-esc="d_analysis + '/' + meses[m_analysis] + '/' + y_analysis"/>
                                            </t>
                                            <span t-else="">No especificada</span>
                                        </td>
                                        <td style="padding:3px;">
                                            <strong>Estado:</strong> 
                                            <span style="color: #28a745; font-weight: bold;">✅ Firmado Digitalmente</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>

                            <!-- Tabla de resultados -->
                            <t t-set="all_params" t-value="analysis.parameter_analysis_ids.filtered(lambda p: p.report_status in ['ready', 'reported'])"/>
                            
                            <t t-if="all_params">
                                <h5 style="font-size: 14px; margin: 15px 0 5px 0;">Resultados:</h5>
                                <table class="table table-bordered" style="width:100%; font-size:11px; border-collapse:collapse;">
                                    <thead>
                                        <tr style="background-color:#2c5aa0; color: white;">
                                            <th style="padding:8px; text-align:left; width:25%;">Parámetro</th>
                                            <th style="padding:8px; text-align:left; width:25%;">Método</th>
                                            <th style="padding:8px; text-align:center; width:20%;">Resultado</th>
                                            <th style="padding:8px; text-align:left; width:30%;">Observaciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <t t-foreach="all_params" t-as="parameter">
                                            <tr class="result-row">
                                                <td style="padding:8px;">
                                                    <t t-if="parameter.microorganism">
                                                        <strong><span t-esc="parameter.microorganism"/></strong>
                                                    </t>
                                                    <t t-else="">
                                                        <strong><span t-esc="parameter.name or 'Sin nombre'"/></strong>
                                                    </t>
                                                </td>
                                                <td style="padding:8px;">
                                                    <span t-esc="parameter.method or 'No especificado'"/>
                                                </td>
                                                <td style="padding:8px; text-align:center; font-weight:bold;">
                                                    <span t-esc="parameter.result_complete or parameter.result_value or 'Sin resultado'"/>
                                                </td>
                                                <td style="padding:8px; font-size:10px;">
                                                    <span t-esc="parameter.analyst_notes or '—'"/>
                                                </td>
                                            </tr>
                                        </t>
                                    </tbody>
                                </table>
                            </t>

                        </div>

                        <!-- SECCIÓN PARA FIRMA MANUAL -->
                        <t t-if="analysis.signature_state == 'signed'">
                            <div class="authorization-section" style="border-color: #6c757d; background-color: #f8f9fa;">
                                <h3 style="font-size: 16px; margin: 0 0 15px 0; color: #6c757d; text-align: center;">
                                    ESPACIO PARA FIRMA AUTÓGRAFA - <span t-esc="analysis.sample_code"/>
                                </h3>
                                
                                <table style="width: 100%; border-collapse: collapse;">
                                    <tr>
                                        <td style="width: 50%; vertical-align: top; padding: 10px; text-align: center;">
                                            <div style="border: 2px solid #6c757d; height: 100px; width: 200px; margin: 0 auto; background-color: white;">
                                                <div style="text-align: center; padding-top: 40px; color: #6c757d; font-style: italic;">
                                                    Espacio para firma autógrafa
                                                </div>
                                            </div>
                                            <div style="margin-top: 10px; border-top: 2px solid #6c757d; padding-top: 5px;">
                                                <strong>Firma Manual</strong>
                                            </div>
                                        </td>
                                        <td style="width: 50%; vertical-align: top; padding: 10px;">
                                            <div style="font-size: 12px; line-height: 1.6;">
                                                <p><strong>Firmado por:</strong> <span t-esc="analysis.sample_signature_name or 'No especificado'"/></p>
                                                <p><strong>Cargo:</strong> <span t-esc="analysis.sample_signature_position or 'No especificado'"/></p>
                                                <p><strong>Fecha de Firma Digital:</strong> 
                                                    <t t-if="analysis.sample_signature_date">
                                                        <t t-set="sign_date" t-value="analysis.sample_signature_date"/>
                                                        <t t-set="d_sign" t-value="sign_date.strftime('%d')"/>
                                                        <t t-set="m_sign" t-value="sign_date.strftime('%m')"/>
                                                        <t t-set="y_sign" t-value="sign_date.strftime('%Y')"/>
                                                        <t t-set="h_sign" t-value="sign_date.strftime('%H:%M')"/>
                                                        <span t-esc="d_sign + '/' + meses[m_sign] + '/' + y_sign + ' ' + h_sign"/>
                                                    </t>
                                                </p>
                                                <p style="margin-top: 20px;"><strong>Fecha de Firma Manual:</strong> _______________</p>
                                            </div>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </t>

                        <!-- Información adicional -->
                        <div style="margin-top: 30px; font-size: 11px; color: #666;">
                            <p>
                                <strong>Nota:</strong> Este informe ha sido firmado digitalmente y se presenta para firma autógrafa adicional según requerimientos específicos.
                            </p>
                            <p style="margin-top: 10px;">
                                <em>Los análisis se realizaron conforme a los métodos indicados y bajo las condiciones establecidas en nuestros procedimientos de calidad.</em>
                            </p>
                        </div>

                    </div>
                </div>
            </t>
        </t>
    </template>

</odoo>