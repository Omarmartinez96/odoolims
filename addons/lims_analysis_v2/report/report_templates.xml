<?xml version="1.0" encoding="utf-8"?>
<odoo>
    
    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE PRELIMINAR -->
    <!-- Ejemplo: <template id="report_analysis_preliminary_template"> -->
    <!-- ========================================================= -->

    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE FINAL -->
    <!-- Ejemplo: <template id="report_analysis_final_template"> -->
    <!-- ========================================================= -->

    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE PARA FIRMA MANUAL -->
    <!-- Ejemplo: <template id="report_analysis_signing_template"> -->
    <!-- ========================================================= -->

    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE BIOBURDEN -->
    <!-- Ejemplo: <template id="report_bioburden_template"> -->
    <!-- ========================================================= -->

    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE PARTÍCULAS VIABLES -->
    <!-- Ejemplo: <template id="report_viable_particles_template"> -->
    <!-- ========================================================= -->

    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE ENDOTOXINAS -->
    <!-- Ejemplo: <template id="report_endotoxin_template"> -->
    <!-- ========================================================= -->

    <!-- ========== TEMPLATE GENERAL ILAC (MEJORADO CON NUEVOS AJUSTES) ========== -->
    <template id="report_general_ilac_template">
        <t t-call="web.html_container">
            <meta charset="UTF-8"/>
            <t t-call-assets="web.report_assets_common" t-js="false"/>
            <t t-set="company" t-value="env.company"/>

            <!-- ESTILOS ESPECÍFICOS PARA ILAC -->
            <style>
                body, .o_report_layout, table, td, th, span, div, p {
                    font-family: Arial, sans-serif !important;
                    font-size: 12px !important;  
                    line-height: 1.3;
                }
                .sample-break {
                    page-break-before: always;
                }
                .page-content {
                    page-break-inside: avoid;
                    min-height: 90vh;
                }
                .section-header {
                    background-color: rgb(218,227,243);
                    font-weight: bold;
                    padding: 6px;  
                    text-align: center;
                    font-size: 12px !important;  
                    margin: 10px 0 5px 0; 
                    page-break-inside: avoid;
                }
                .data-table {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 11px !important; 
                    margin: 8px 0; 
                    page-break-inside: auto;
                    border: none !important;
                }
                .data-table th, .data-table td {
                    border: none !important;
                    padding: 5px 3px;  
                    vertical-align: top;
                    text-align: center;
                }
                .data-table th {
                    background-color: rgb(218,227,243);
                    font-weight: bold;
                    text-align: center;
                    font-size: 10px !important; 
                }
                .data-table tr {
                    page-break-inside: avoid;
                }
                .info-grid {
                    width: 100%;
                    border-collapse: collapse;
                    font-size: 11px !important; 
                    margin: 1px 0;  
                }
                .info-grid td {
                    padding: 1px 2px;  
                    vertical-align: top;
                    line-height: 1.2;
                    text-align: left !important;  
                }
                .label {
                    font-weight: bold;
                    font-size: 11px !important; 
                }
                .two-column {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 8px 0;  
                    page-break-inside: avoid;
                }
                .two-column td {
                    width: 50%;
                    vertical-align: top;
                    padding: 0 8px; 
                }
                .header-table {
                    width: 100% !important;
                    border-collapse: separate !important;
                    border-spacing: 0 !important;
                    margin: 0 !important;
                    padding: 30px 0 !important;  
                    border: none !important;
                    table-layout: fixed;
                    min-height: 150px !important;  
                }
                .header-table td {
                    border: none !important;
                    padding: 25px 15px !important; 
                    vertical-align: middle;
                    height: 150px !important;  
                }
                .header-logo {
                    width: 20%;
                    text-align: left;
                }
                .header-title {
                    width: 60%;
                    text-align: center;
                }
                .header-ilac {
                    width: 20%;
                    text-align: right;
                }
            </style>

            <!-- HEADER GLOBAL (FUERA DEL LOOP) -->
            <div class="header">
                <!-- ✅ CORREGIDO: Header con altura fija más grande -->
                <table class="header-table" style="height: 180px;">  <!-- ✅ NUEVO: Altura fija -->
                    <tr style="height: 150px;">  <!-- ✅ NUEVO: Altura fija del row -->
                        <td class="header-logo">
                            <img t-if="company.logo"
                                t-att-src="image_data_uri(company.logo)"
                                style="max-height: 140px; width: auto;"/>  <!-- ✅ Era 120px, ahora 140px -->
                        </td>
                        <td class="header-title">
                            <!-- ✅ ACTUALIZADO: Título con más padding y tamaño -->
                            <div style="background-color: #f0f0f0; padding: 25px 30px; margin: 0; width: 100%; box-sizing: border-box; min-height: 80px; display: flex; align-items: center; justify-content: center;">
                                <strong style="font-size: 22px; font-family: Arial, sans-serif;">  <!-- ✅ Era 18px, ahora 22px -->
                                    INFORME DE ENSAYO
                                </strong>
                            </div>
                        </td>
                        <td class="header-ilac">
                            <div style="border: 1px solid #000; padding: 15px; min-height: 80px; display: flex; align-items: center; justify-content: center; font-size: 12px; width: 100%; box-sizing: border-box;">  <!-- ✅ Era 60px altura y 11px font, ahora 80px y 12px -->
                                [ILAC LOGOS]
                            </div>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- FOOTER GLOBAL (FUERA DEL LOOP) -->
            <div class="footer">
                <table style="width: 100%; font-size: 9px; margin: 0; padding: 0; border-top: 1px solid #000; font-family: Arial, sans-serif;">  <!-- ✅ Era 8px, ahora 9px -->
                    <tr>
                        <td style="width: 33%; text-align: left; padding: 3px;">  <!-- ✅ Era 2px, ahora 3px -->
                            Teléfono: (664) 973-8185
                        </td>
                        <td style="width: 33%; text-align: center; padding: 3px;">
                            FOR-022 Rev. 03 / PROC-006
                        </td>
                        <td style="width: 33%; text-align: right; padding: 3px;">
                            contacto@proteuslaboratorio.com
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: center; font-size: 8px; padding: 2px;">  <!-- ✅ Era 7px, ahora 8px -->
                            Av. Defensores de Baja California 2163 Plaza Marina Local 5-A, Empleado Postal, Tijuana B.C.
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: center; font-size: 8px; padding: 2px;">
                            Documento controlado, prohibida su reproducción parcial o total sin autorización.
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align: center; font-size: 8px; padding: 2px;">
                            Página <span class="page"/> de <span class="topage"/>
                        </td>
                    </tr>
                </table>
            </div>

            <!-- CONTENIDO POR ANÁLISIS -->
            <t t-foreach="docs" t-as="analysis">
                
                <!-- Variables de configuración DENTRO del loop -->
                <t t-set="report_config" t-value="context.get('custom_report_config', {})"/>
                <t t-set="language" t-value="report_config.get('language', 'es')"/>
                <t t-set="status" t-value="report_config.get('status', 'final')"/>

                <!-- CONTENIDO PRINCIPAL -->
                <div t-att-class="'page-content' + (' sample-break' if analysis_index > 0 else '')">
                    <div class="main-content">

                        <!-- Badge preliminar si aplica -->
                        <t t-if="status == 'preliminary'">
                            <div style="text-align: center; margin: 15px 0;">  <!-- ✅ Era 10px, ahora 15px -->
                                <span style="background-color: #ffc107; color: #212529; padding: 8px 15px; border-radius: 5px; font-weight: bold; font-size: 14px;">  <!-- ✅ Más grande -->
                                    PRELIMINAR
                                </span>
                            </div>
                        </t>

                        <!-- ✅ ACTUALIZADO: INFORMACIÓN SUPERIOR MÁS COMPACTA Y ALINEADA -->
                        <table class="info-grid" style="margin-top: 15px;">  <!-- ✅ Era 10px, ahora 15px -->
                            <tr>
                                <td class="label" style="width: 25%;">
                                    <t t-if="language == 'es'">Identificación de la muestra:</t>
                                    <t t-else="">Sample identification:</t>
                                </td>
                                <td style="width: 25%;"><span t-esc="analysis.sample_identifier or 'Sin identificación'"/></td>
                                <td class="label" style="width: 25%;">  <!-- ✅ QUITADO: text-align: right -->
                                    <t t-if="language == 'es'">Fecha de emisión:</t>
                                    <t t-else="">Issue date:</t>
                                </td>
                                <td style="width: 25%;">  <!-- ✅ QUITADO: text-align: right -->
                                    <t t-set="today" t-value="datetime.datetime.now()"/>
                                    <span t-esc="today.strftime('%d/%b/%Y')"/>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">
                                    <t t-if="language == 'es'">Descripción de la muestra:</t>
                                    <t t-else="">Sample description:</t>
                                </td>
                                <td>
                                    <t t-if="analysis.sample_reception_id and analysis.sample_reception_id.sample_id">
                                        <span t-esc="analysis.sample_reception_id.sample_id.sample_description or 'Sin descripción'"/>
                                    </t>
                                    <t t-else="">Sin descripción</t>
                                </td>
                                <td class="label">  <!-- ✅ QUITADO: text-align: right -->
                                    <t t-if="language == 'es'">Cadena de custodia:</t>
                                    <t t-else="">Chain of custody:</t>
                                </td>
                                <td><span t-esc="analysis.custody_chain_code or 'Sin código'"/></td>  <!-- ✅ QUITADO: text-align: right -->
                            </tr>
                        </table>

                        <!-- DATOS DEL CLIENTE -->
                        <div class="section-header">
                            <t t-if="language == 'es'">DATOS DEL CLIENTE</t>
                            <t t-else="">CUSTOMER DATA</t>
                        </div>
                        <table class="info-grid">
                            <tr>
                                <td class="label" style="width: 22%;">
                                    <t t-if="language == 'es'">Nombre o Razón social:</t>
                                    <t t-else="">Name or Company name:</t>
                                </td>
                                <td style="width: 78%;">
                                    <t t-if="analysis.customer_id">
                                        <span t-esc="analysis.customer_id.name"/>
                                    </t>
                                    <t t-else="">Sin cliente especificado</t>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">
                                    <t t-if="language == 'es'">Dirección fiscal:</t>
                                    <t t-else="">Fiscal address:</t>
                                </td>
                                <td>
                                    <t t-if="analysis.customer_id">
                                        <span t-esc="analysis.customer_id.street or ''"/>
                                        <t t-if="analysis.customer_id.street2">, <span t-esc="analysis.customer_id.street2"/></t>
                                        <t t-if="analysis.customer_id.city">, <span t-esc="analysis.customer_id.city"/></t>
                                        <t t-if="analysis.customer_id.zip"> C.P. <span t-esc="analysis.customer_id.zip"/></t>
                                    </t>
                                    <t t-else="">Sin dirección</t>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">
                                    <t t-if="language == 'es'">Código de cliente:</t>
                                    <t t-else="">Customer code:</t>
                                </td>
                                <td>
                                    <t t-if="analysis.customer_id and analysis.customer_id.client_code">
                                        <span t-esc="analysis.customer_id.client_code"/>
                                    </t>
                                    <t t-else="">N/A</t>
                                </td>
                            </tr>
                            <tr>
                                <td class="label">
                                    <t t-if="language == 'es'">Contacto:</t>
                                    <t t-else="">Contact:</t>
                                </td>
                                <td>
                                    <t t-if="analysis.custody_chain_id and analysis.custody_chain_id.contact_ids">
                                        <span t-esc="', '.join([c.name for c in analysis.custody_chain_id.contact_ids])"/>
                                    </t>
                                    <t t-else="">N/A</t>
                                </td>
                            </tr>
                        </table>

                        <!-- INFORMACIÓN DE MUESTREO Y RECEPCIÓN -->
                        <table class="two-column">
                            <tr>
                                <td>
                                    <div class="section-header">
                                        <t t-if="language == 'es'">INFORMACIÓN DE MUESTREO</t>
                                        <t t-else="">SAMPLING INFORMATION</t>
                                    </div>
                                    <table class="info-grid">
                                        <tr>
                                            <td class="label" style="width: 45%;">
                                                <t t-if="language == 'es'">Fecha y hora de muestreo:</t>
                                                <t t-else="">Sampling date and time:</t>
                                            </td>
                                            <td style="width: 55%;">
                                                <t t-if="analysis.sample_reception_id and analysis.sample_reception_id.sample_id and analysis.sample_reception_id.sample_id.sampling_date">
                                                    <span t-esc="analysis.sample_reception_id.sample_id.sampling_date"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label">Tipo de muestra:</td>
                                            <td>
                                                <t t-if="analysis.sample_reception_id and analysis.sample_reception_id.sample_id and analysis.sample_reception_id.sample_id.sample_type_id">
                                                    <span t-esc="analysis.sample_reception_id.sample_id.sample_type_id.name"/>
                                                </t>
                                                <t t-else="">Producto terminado</t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label">Sitio de muestreo:</td>
                                            <td>Empresa</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Muestreador:</td>
                                            <td>Cliente</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Método/plan de muestreo (si aplica):</td>
                                            <td>N/A</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Observaciones:</td>
                                            <td>Muestra proporcionada por el cliente</td>
                                        </tr>
                                    </table>
                                </td>
                                
                                <td>
                                    <div class="section-header">
                                        <t t-if="language == 'es'">INFORMACIÓN DE RECEPCIÓN</t>
                                        <t t-else="">RECEPTION INFORMATION</t>
                                    </div>
                                    <table class="info-grid">
                                        <tr>
                                            <td class="label" style="width: 45%;">Fecha y hora de recepción:</td>
                                            <td style="width: 55%;">
                                                <t t-if="analysis.sample_reception_id and analysis.sample_reception_id.reception_date">
                                                    <span t-esc="analysis.sample_reception_id.reception_date.strftime('%d/%b/%Y')"/>
                                                </t>
                                                <t t-else="">-</t>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td class="label">Clave de la muestra:</td>
                                            <td><span t-esc="analysis.sample_code or 'Sin código'"/></td>
                                        </tr>
                                        <tr>
                                            <td class="label">Cantidad de muestra:</td>
                                            <td>100g</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Temperatura de recepción:</td>
                                            <td>-</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Recipiente de la muestra:</td>
                                            <td>Envase original</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Recibió:</td>
                                            <td>Daniela Rangel</td>
                                        </tr>
                                        <tr>
                                            <td class="label">Observaciones:</td>
                                            <td>Sin observaciones</td>
                                        </tr>
                                    </table>
                                </td>
                            </tr>
                        </table>

                        <!-- DATOS DEL ANÁLISIS -->
                        <div class="section-header">DATOS DEL ANÁLISIS</div>
                        
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th style="width: 14%;">Parámetro</th>
                                    <th style="width: 18%;">Método</th>
                                    <th style="width: 3%;">C</th>
                                    <th style="width: 3%;">T</th>
                                    <th style="width: 4%;">LAB</th>
                                    <th style="width: 12%;">Resultado</th>
                                    <th style="width: 10%;">Unidades</th>
                                    <th style="width: 12%;">Referencia</th>
                                    <th style="width: 10%;">Fecha de análisis</th>
                                    <th style="width: 4%;">AN</th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-set="analysis_params" t-value="analysis.parameter_analysis_ids.filtered(lambda p: (p.report_status == 'ready' if status == 'preliminary' else p.report_status in ['ready', 'reported']))"/>
                                <t t-foreach="analysis_params" t-as="parameter">
                                    <tr>
                                        <td><span t-esc="parameter.microorganism or parameter.name or 'Sin nombre'"/></td>
                                        <td><span t-esc="parameter.method or 'No especificado'"/></td>
                                        <td>C</td>
                                        <td>T</td>
                                        <td>LAB</td>
                                        <td><span t-esc="parameter.result_value or 'Sin resultado'"/></td>
                                        <td>
                                            <t t-if="parameter.result_unit_selection == 'custom'">
                                                <span t-esc="parameter.custom_unit or ''"/>
                                            </t>
                                            <t t-elif="parameter.qualitative_unit_selection == 'custom'">
                                                <span t-esc="parameter.qualitative_custom_unit or ''"/>
                                            </t>
                                            <t t-else="">
                                                <span t-esc="parameter.unit or ''"/>
                                            </t>
                                        </td>
                                        <td>Límites del cliente</td>
                                        <td>
                                            <t t-if="parameter.analysis_date">
                                                <span t-esc="parameter.analysis_date.strftime('%d/%b/%Y')"/>
                                            </t>
                                            <t t-else="">-</t>
                                        </td>
                                        <td><span t-esc="parameter.analyst_names or 'N/A'"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>

                        <!-- INFORMACIÓN ADICIONAL -->
                        <div style="margin-top: 15px; font-size: 11px;">  <!-- ✅ Era 10px y 9px, ahora 15px y 11px -->
                            <table class="info-grid">
                                <tr>
                                    <td class="label" style="width: 25%;">Referencia normativa:</td>
                                    <td style="width: 75%;">Límites de referencia proporcionados por el cliente.</td>
                                </tr>
                                <tr>
                                    <td class="label">Observaciones analíticas y de resultados:</td>
                                    <td>Sin observaciones.</td>
                                </tr>
                            </table>
                        </div>

                        <!-- NOTA FINAL -->
                        <div style="margin-top: 15px; font-size: 10px;">  <!-- ✅ Era 10px y 8px, ahora 15px y 10px -->
                            <p><strong>Nota:</strong> Los resultados solo están relacionados con la porción de muestra analizada.</p>
                        </div>

                        <!-- SECCIÓN DE FIRMA -->
                        <div style="margin-top: 40px; text-align: right;">  <!-- ✅ Era 30px, ahora 40px -->
                            <div style="width: 200px; margin-left: auto;">
                                <div style="border-bottom: 1px solid #000; margin-bottom: 8px; height: 50px;"></div>  <!-- ✅ Era 5px y 40px, ahora 8px y 50px -->
                                <div style="text-align: center; font-size: 11px;">  <!-- ✅ Era 9px, ahora 11px -->
                                    <strong>Bryan Manuel Zamora Luna</strong><br/>
                                    Aseguramiento de la Calidad
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </t>
        </t>
    </template>

    <!-- ========================================================= -->
    <!-- AGREGAR AQUÍ: TEMPLATE GENERAL SIN ILAC -->
    <!-- Ejemplo: <template id="report_general_no_ilac_template"> -->
    <!-- ========================================================= -->

</odoo>