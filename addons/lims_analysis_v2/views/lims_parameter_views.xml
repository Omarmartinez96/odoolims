<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        
        <!-- ========== VISTA FORMULARIO DE PAR√ÅMETRO DE AN√ÅLISIS ========== -->
        <record id="view_parameter_analysis_v2_form" model="ir.ui.view">
            <field name="name">lims.parameter.analysis.v2.form</field>
            <field name="model">lims.parameter.analysis.v2</field>
            <field name="arch" type="xml">
                <form string="Par√°metro de An√°lisis v2">
                    
                    <sheet>
                        <!-- T√≠tulo -->
                        <div class="oe_title">
                            <h1>
                                <field name="name" readonly="1"/>
                            </h1>
                            <h3>
                                <field name="microorganism" readonly="1" placeholder="Sin microorganismo especificado"/>
                            </h3>
                        </div>

                        <!-- Informaci√≥n b√°sica -->
                        <group>
                            <group string="üìã Informaci√≥n del Par√°metro">
                                <field name="method" readonly="1"/>
                                <field name="category" readonly="1"/>
                                <field name="unit" readonly="1"/>
                                <field name="result_type" widget="radio" required="1"/>
                            </group>
                            <group string="üìÖ Informaci√≥n del An√°lisis">
                                <field name="analysis_start_date"/>
                                <field name="analysis_commitment_date"/>
                                <field name="analyst_names" placeholder="Iniciales separadas por comas"/>
                                <field name="analysis_status" 
                                       decoration-success="analysis_status == 'completed'"
                                       decoration-info="analysis_status == 'in_progress'"
                                       decoration-muted="analysis_status == 'draft'"/>
                                <field name="report_status" readonly="1"
                                       decoration-success="report_status == 'ready'"
                                       decoration-info="report_status == 'reported'"
                                       decoration-muted="report_status == 'draft'"/>
                            </group>
                        </group>

                        <!-- Configuraci√≥n autom√°tica de procesos seg√∫n categor√≠a y tipo -->
                        <group string="üîß Configuraci√≥n de Procesos" invisible="category != 'microbiological'">
                            <div class="alert alert-info" style="margin-bottom: 10px;" colspan="4">
                                <strong>‚ÑπÔ∏è Configuraci√≥n Autom√°tica:</strong> 
                                Selecciona los procesos que requiere este par√°metro para mostrar las pesta√±as correspondientes.
                            </div>
                            <field name="requires_pre_enrichment" invisible="result_type != 'qualitative'"/>
                            <field name="requires_selective_enrichment" invisible="result_type != 'qualitative'"/>
                            <field name="requires_confirmation"/>
                            <field name="requires_ph_adjustment"/>
                        </group>

                        <!-- Notebook principal -->
                        <notebook>
                            
                            <!-- TAB DE MEDIOS Y REACTIVOS UNIFICADO -->
                            <page string="üß´ Medios y Reactivos">
                                <field name="media_ids" nolabel="1">
                                    <list string="Medios Utilizados" editable="bottom">
                                        <field name="process_type" string="Proceso"/>
                                        <field name="media_source" string="Origen"/>
                                        <field name="culture_media_name" string="Nombre del Medio"/>
                                        <field name="culture_media_batch_id" 
                                               string="Lote Interno"
                                               invisible="media_source != 'internal'"/>
                                        <field name="external_batch_code" 
                                               string="Lote Externo" 
                                               invisible="media_source != 'external'"/>
                                        <field name="media_usage" string="Uso"/>
                                        <field name="requires_incubation" string="Incubaci√≥n?"/>
                                        <field name="incubation_status" 
                                               invisible="requires_incubation == False"
                                               decoration-success="incubation_status == 'completed'"
                                               decoration-warning="incubation_status == 'overdue'"
                                               decoration-info="incubation_status == 'active'"/>
                                        <field name="qualitative_result" string="Resultado"/>
                                    </list>
                                    
                                    <form string="Medio Utilizado">
                                        <group>
                                            <group>
                                                <field name="process_type" required="1"/>
                                                <field name="media_source" widget="radio"/>
                                                <field name="culture_media_name" 
                                                       placeholder="Nombre del medio de cultivo"
                                                       required="1"/>
                                            </group>

                                            <group string="Lote del Medio">
                                                <field name="culture_media_batch_id" 
                                                       invisible="media_source != 'internal'"
                                                       placeholder="Seleccionar lote interno"
                                                       options="{'no_create': True}"/>
                                                <field name="external_batch_code" 
                                                       invisible="media_source != 'external'"
                                                       placeholder="C√≥digo del lote externo"
                                                       required="media_source == 'external'"/>
                                                <field name="media_usage" 
                                                       string="Uso del Medio"
                                                       required="1"/>
                                            </group>
                                        </group>
                                        
                                        <!-- Incubaci√≥n -->
                                        <group string="üå°Ô∏è Incubaci√≥n">
                                            <group>
                                                <field name="requires_incubation" string="¬øRequiere Incubaci√≥n?"/>
                                                <field name="incubation_equipment" 
                                                       invisible="requires_incubation == False"
                                                       placeholder="Equipo utilizado"/>
                                                <field name="incubation_start_date" invisible="requires_incubation == False"/>
                                                <field name="incubation_start_time" placeholder="HH:MM" invisible="requires_incubation == False"/>
                                            </group>
                                            <group>
                                                <field name="incubation_end_date" invisible="requires_incubation == False"/>
                                                <field name="incubation_end_time" placeholder="HH:MM" invisible="requires_incubation == False"/>
                                                <field name="incubation_end_date_real" invisible="requires_incubation == False"/>
                                                <field name="incubation_end_time_real" placeholder="HH:MM" invisible="requires_incubation == False"/>
                                            </group>
                                        </group>
                                        
                                        <group string="üìä Estado de Incubaci√≥n" 
                                               invisible="requires_incubation == False">
                                            <group>
                                                <field name="incubation_status" readonly="1"/>
                                                <field name="time_remaining" readonly="1" 
                                                       invisible="incubation_status != 'active'"/>
                                                <field name="is_overdue" readonly="1" widget="boolean_toggle"/>
                                            </group>
                                            <group>
                                                <button name="action_mark_completed" 
                                                        type="object" 
                                                        string="‚úÖ Marcar Completada" 
                                                        class="btn-success"
                                                        invisible="incubation_status == 'completed'"/>
                                                <button name="action_refresh_status" 
                                                        type="object" 
                                                        string="üîÑ Actualizar Estado" 
                                                        class="btn-secondary"/>
                                            </group>
                                        </group>

                                        <group string="üß™ Resultado en este Medio">
                                            <field name="qualitative_result"/>
                                        </group>

                                        <group string="üìù Notas de Preparaci√≥n">
                                            <field name="preparation_notes" nolabel="1"
                                                   placeholder="Instrucciones especiales, observaciones, etc..."/>
                                        </group>
                                    </form>
                                </field>
                            </page>

                            <!-- TAB DE DATOS CRUDOS (SOLO MICROBIOLOG√çA CUANTITATIVA) -->
                            <page string="üî¢ Datos Crudos de Diluciones" 
                                  invisible="category != 'microbiological' or result_type != 'quantitative'">
                                
                                <div class="alert alert-info" style="margin-bottom: 15px;">
                                    <strong>üìù Informaci√≥n:</strong> Esta tabla es para registrar datos crudos √∫nicamente. 
                                    Los c√°lculos son informativos. El resultado final debe ingresarse manualmente en la pesta√±a "Resultado".
                                </div>
                                
                                <field name="raw_dilution_data_ids" nolabel="1">
                                    <list string="Diluciones" editable="bottom">
                                        <field name="method_type" width="20%"/>
                                        <field name="dilution_factor" width="20%"/>
                                        <!-- UFC -->
                                        <field name="ufc_count" invisible="method_type != 'ufc'" width="15%"/>
                                        <!-- NMP -->
                                        <field name="positive_tubes" invisible="method_type != 'nmp'" width="15%"/>
                                        <field name="total_tubes" invisible="method_type != 'nmp'" width="15%"/>
                                        <field name="nmp_result" invisible="method_type != 'nmp'" width="20%"/>
                                        <!-- Resultado calculado -->
                                        <field name="calculated_result" readonly="1" width="30%"/>
                                        <field name="observations" optional="show"/>
                                    </list>
                                </field>
                                
                                <!-- C√°lculos informativos -->
                                <group string="üìä C√°lculos Informativos (Solo Referencia)">
                                    <field name="dilution_calculations" nolabel="1" readonly="1" 
                                           widget="text" style="font-family: monospace;"/>
                                </group>
                            </page>

                            <!-- TAB DE CONTROL DE CALIDAD -->
                            <page string="üî¨ Control de Calidad">
                                
                                <div class="alert alert-info" style="margin-bottom: 15px;">
                                    <strong>üìã Controles de Calidad:</strong> 
                                    Estos controles garantizan la calidad y confiabilidad de los resultados.
                                </div>
                                
                                <!-- Bot√≥n para copiar desde plantilla -->
                                <div class="oe_button_box" style="margin-bottom: 15px;">
                                    <button type="object" 
                                            name="action_copy_qc_from_template" 
                                            string="üìã Copiar desde Plantilla" 
                                            class="btn-secondary"
                                            help="Copiar controles desde la plantilla del par√°metro"/>
                                </div>
                                
                                <field name="executed_qc_ids" nolabel="1">
                                    <list string="Controles de Calidad" editable="bottom">
                                        <field name="qc_type_id" string="Tipo de Control" width="25%"/>
                                        <field name="expected_result" string="Resultado Esperado" width="15%"/>
                                        <field name="actual_result" string="Resultado Obtenido" width="15%"/>
                                        
                                        <field name="control_status" string="Estado" width="15%"
                                               decoration-success="control_status == 'passed'"
                                               decoration-warning="control_status == 'in_progress'"
                                               decoration-danger="control_status == 'failed'"
                                               decoration-muted="control_status == 'not_applicable'"/>
                                        
                                        <field name="execution_date" string="Fecha" width="10%"/>
                                        <field name="executed_by" string="Realizado Por" width="15%"/>
                                        
                                        <!-- Botones r√°pidos -->
                                        <button name="action_mark_passed" type="object" 
                                                string="‚úÖ" class="btn-success btn-sm" 
                                                title="Marcar como exitoso"/>
                                        <button name="action_mark_failed" type="object" 
                                                string="‚ùå" class="btn-danger btn-sm" 
                                                title="Marcar como fallido"/>
                                        <button name="action_reset_control" type="object" 
                                                string="üîÑ" class="btn-secondary btn-sm" 
                                                title="Restablecer"/>
                                    </list>
                                </field>
                            </page>

                            <!-- TAB DE RESULTADO FINAL -->
                            <page string="üìä Resultado Final">
                                
                                <!-- RESULTADO CUALITATIVO -->
                                <group string="üìä Resultado Cualitativo" 
                                       invisible="result_type != 'qualitative'">
                                    <field name="result_qualitative"/>
                                    <field name="qualitative_unit_selection" string="Unidad/Base"/>
                                    <field name="qualitative_custom_unit" 
                                           placeholder="Especificar unidad personalizada"
                                           invisible="qualitative_unit_selection != 'custom'"/>
                                </group>

                                <!-- RESULTADO CUANTITATIVO -->
                                <group string="üî¢ Resultado Cuantitativo" 
                                       invisible="result_type != 'quantitative'">
                                    <field name="result_numeric"/>
                                    <field name="result_unit"/>
                                    <field name="result_unit_selection"/>
                                    <field name="custom_unit" 
                                           placeholder="Especificar unidad"
                                           invisible="result_unit_selection != 'custom'"/>
                                    <field name="below_detection_limit"/>
                                    <field name="above_quantification_limit"/>
                                </group>

                                <!-- RESULTADO PRINCIPAL -->
                                <group string="‚úÖ Resultado Principal" colspan="4">
                                    <field name="result_value" 
                                           class="o_field_highlight"
                                           style="font-size: 18px; font-weight: bold;"
                                           placeholder="Ingrese el resultado final aqu√≠..."/>
                                </group>

                                <!-- EQUIPOS ADICIONALES -->
                                <group string="üîß Equipos Adicionales Utilizados">
                                    <field name="equipment_involved_ids" nolabel="1">
                                        <list string="Equipos" editable="bottom">
                                            <field name="equipment_id" string="Equipo"/>
                                            <field name="usage" string="Uso" placeholder="Especificar uso del equipo"/>
                                            <field name="usage_date" string="Fecha"/>
                                            <field name="used_by" string="Utilizado por"/>
                                        </list>
                                    </field>
                                </group>

                                <!-- OBSERVACIONES -->
                                <group string="üìù Observaciones del Analista">
                                    <field name="analyst_notes" nolabel="1"
                                           placeholder="Observaciones t√©cnicas del an√°lisis..."/>
                                </group>
                            </page>

                            <!-- TAB DE RESULTADOS DE CONFIRMACI√ìN -->
                            <page string="‚úÖ Resultados de Confirmaci√≥n" invisible="requires_confirmation == False">
                                <field name="confirmation_results_ids" nolabel="1">
                                    <list string="Resultados por Lote de Medio" editable="bottom">
                                        <field name="batch_display_name" string="Lote de Medio" readonly="1"/>
                                        <field name="result" string="Resultado" placeholder="Ej: Positivo, Negativo, etc."/>
                                        <field name="qualitative_result" string="Resultado Estructurado"/>
                                        <field name="result_date" string="Fecha"/>
                                        <field name="recorded_by" string="Registrado por"/>
                                        <field name="observations" string="Observaciones" optional="show"/>
                                    </list>
                                </field>
                            </page>

                        </notebook>

                    </sheet>
                </form>
            </field>
        </record>

        <!-- ========== VISTA LISTA DE PAR√ÅMETROS ========== -->
        <record id="view_parameter_analysis_v2_list" model="ir.ui.view">
            <field name="name">lims.parameter.analysis.v2.list</field>
            <field name="model">lims.parameter.analysis.v2</field>
            <field name="arch" type="xml">
                <list string="Par√°metros de An√°lisis v2">
                    <field name="analysis_id"/>
                    <field name="name"/>
                    <field name="microorganism"/>
                    <field name="method"/>
                    <field name="result_type"/>
                    <field name="analysis_status" 
                           decoration-success="analysis_status == 'completed'"
                           decoration-info="analysis_status == 'in_progress'"
                           decoration-muted="analysis_status == 'draft'"/>
                    <field name="report_status" 
                           decoration-success="report_status == 'ready'"
                           decoration-info="report_status == 'reported'"
                           decoration-muted="report_status == 'draft'"/>
                    <field name="result_complete" class="o_field_highlight"/>
                    <field name="analyst_names"/>
                    <field name="analysis_start_date"/>
                </list>
            </field>
        </record>

        <!-- ========== ACCI√ìN PARA PAR√ÅMETROS ========== -->
        <record id="action_parameter_analysis_v2" model="ir.actions.act_window">
            <field name="name">Par√°metros de An√°lisis v2</field>
            <field name="res_model">lims.parameter.analysis.v2</field>
            <field name="view_mode">list,form</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No hay par√°metros de an√°lisis
                </p>
                <p>
                    Los par√°metros se crean autom√°ticamente al crear an√°lisis
                </p>
            </field>
        </record>

    </data>
</odoo>